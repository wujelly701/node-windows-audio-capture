# v2.7.0 开发进度报告

**报告日期**: 2025年10月15日  
**版本目标**: v2.7.0 - API 完善与生态优化  
**当前状态**: P0 特性开发中

---

## 📊 进度总结

### 已完成 ✅

1. **规划文档**: 创建了 `V2.7_ROADMAP.md`，详细规划 P0/P1/P2 特性
2. **代码修改尝试**: 尝试将 Zero-Copy 改为默认启用
3. **编译验证**: C++ 代码编译通过
4. **基本功能验证**: 实例化测试通过

### 遇到的技术挑战 ⚠️

#### 问题 1: N-API 回调异常

**现象**:
```
(node:7936) [DEP0168] DeprecationWarning: Uncaught N-API callback exception detected
```

**出现频率**: 非常高，几乎每次回调都触发

**初步分析**:
- Buffer Pool 使用 Singleton 模式
- `ExternalBufferFactory::Initialize()` 只会初始化一次
- 多个 `AudioCapture` 实例可能导致初始化冲突
- Zero-Copy 默认启用可能揭示了之前隐藏的问题

#### 问题 2: Buffer Pool Hit Rate 低

**v2.6.0 测试数据**:
- Pool 大小: 100 buffers
- Hit Rate: 0.33% (1小时测试)
- 原因: V8 GC 延迟导致 buffer 回收慢

**影响**:
- 大部分时间都在动态分配新 buffer
- Buffer Pool 的预期优化效果未达到

---

## 🔍 根本原因分析

### 架构问题

**当前设计 (v2.6)**:
```cpp
// Singleton 模式
ExternalBufferFactory& ExternalBufferFactory::Instance() {
    static ExternalBufferFactory instance;
    return instance;
}

// 只初始化一次
void ExternalBufferFactory::Initialize(size_t buffer_size, size_t pool_size) {
    std::lock_guard<std::mutex> lock(factory_mutex_);
    if (!buffer_pool_) {
        buffer_pool_ = std::make_unique<BufferPool>(buffer_size, pool_size);
    }
}
```

**问题**:
- ✅ 单例模式保证全局唯一
- ❌ 多个 `AudioCapture` 实例可能期望不同的 pool 配置
- ❌ 一旦初始化就无法更改配置
- ❌ 默认启用 Zero-Copy 会强制所有实例使用同一个 pool

### 为什么 v2.6 opt-in 设计没问题？

**v2.6 用户行为**:
1. 用户显式设置 `useExternalBuffer: true`
2. 只有需要高性能的场景才启用
3. 通常只有一个 `AudioCapture` 实例
4. Pool 配置冲突不明显

**v2.7 默认启用后**:
1. 所有实例都自动启用 Zero-Copy
2. 多实例场景更常见
3. 可能有不同的性能需求
4. Pool 配置冲突变得明显

---

## 💡 解决方案探讨

### 方案 1: 重构 Buffer Pool 初始化 ⭐⭐⭐

**思路**: 允许多次初始化，每次检查配置是否一致

```cpp
void ExternalBufferFactory::Initialize(size_t buffer_size, size_t pool_size) {
    std::lock_guard<std::mutex> lock(factory_mutex_);
    
    if (buffer_pool_) {
        // 已初始化 - 检查配置是否一致
        if (buffer_pool_->GetBufferSize() == buffer_size &&
            buffer_pool_->GetPoolSize() == pool_size) {
            // 配置一致 - 复用现有 pool
            return;
        } else {
            // 配置不一致 - 记录警告但不重新创建
            // (避免破坏已有实例的 buffer)
            return;
        }
    }
    
    // 首次初始化
    buffer_pool_ = std::make_unique<BufferPool>(buffer_size, pool_size);
}
```

**优点**:
- ✅ 向后兼容
- ✅ 不破坏现有实例
- ✅ 简单直接

**缺点**:
- ❌ 不能解决 N-API 异常问题（需要进一步调查）
- ❌ 配置不一致时的处理逻辑需要仔细设计

---

### 方案 2: 延后 Zero-Copy 默认启用 ⭐⭐⭐⭐⭐

**思路**: 先实现自适应 Buffer Pool，然后再默认启用

**理由**:
1. **稳定性优先**: v2.6 已验证 opt-in 的稳定性
2. **性能优化**: 自适应 Pool 可以提高 hit rate (0.33% → 2-5%)
3. **更好的用户体验**: 智能调整比固定配置更合理
4. **降低风险**: 分步实施降低引入 bug 的风险

**开发顺序**:
```
v2.7.0:
1. 实现自适应 Buffer Pool ✅ 先做
2. 测试并验证性能提升
3. 作为 opt-in 发布

v2.8.0:
1. 在自适应 Pool 稳定后再考虑默认启用
2. 充分测试多实例场景
3. 解决 N-API 异常问题
```

**优点**:
- ✅ 降低开发风险
- ✅ 每个版本聚焦一个核心特性
- ✅ 更容易隔离和修复问题
- ✅ 给用户更多时间适应

**缺点**:
- ❌ v2.7.0 不包含"默认启用"特性
- ❌ 需要再等一个版本

---

### 方案 3: 每实例 Buffer Pool ⭐⭐

**思路**: 每个 `AudioCapture` 实例都有自己的 Buffer Pool

```cpp
class AudioProcessor {
private:
    std::unique_ptr<BufferPool> buffer_pool_; // 实例级别
    bool useExternalBuffer_;
};
```

**优点**:
- ✅ 完全隔离，没有共享状态
- ✅ 每个实例可以独立配置
- ✅ 避免 Singleton 问题

**缺点**:
- ❌ 内存开销更大（每个实例 100 buffers）
- ❌ 需要大量重构代码
- ❌ 多实例场景下总内存占用可能很高

---

## 🎯 建议方案

**采用方案 2: 延后 Zero-Copy 默认启用**

### v2.7.0 目标调整

#### 新的 P0 特性

1. **自适应 Buffer Pool** (替代原 P0 #1)
   - 动态调整 pool 大小 (50-200 buffers)
   - 根据 hit rate 自动扩缩容
   - 提供配置选项

   ```typescript
   interface AudioCaptureOptions {
     bufferPoolSize?: number | 'auto';  // 默认 'auto'
     bufferPoolStrategy?: 'fixed' | 'adaptive';  // 默认 'adaptive'
     bufferPoolMin?: number;  // 最小池大小，默认 50
     bufferPoolMax?: number;  // 最大池大小，默认 200
   }
   ```

2. **Buffer Pool 统计增强**
   - 实时 hit rate 跟踪
   - 动态调整历史记录
   - 性能监控 API

3. **完整测试覆盖**
   - 单实例 vs 多实例对比
   - 不同 pool 策略对比
   - 长期稳定性验证

#### v2.7.0 非目标

- ❌ Zero-Copy 默认启用 (延后到 v2.8.0)
- ❌ 多实例 pool 共享问题解决

### v2.8.0 规划

1. 在 v2.7.0 稳定后
2. 基于自适应 Pool 的实测数据
3. 充分测试 N-API 异常问题
4. 如果一切顺利，才默认启用 Zero-Copy

---

## 📅 时间线调整

### v2.7.0 (2025年12月)

```
2025-11 月初 - 开发启动
2025-11 月中 - 自适应 Buffer Pool 完成
2025-11 月底 - v2.7.0-alpha 发布
2025-12 月初 - 测试和修复
2025-12 月中 - v2.7.0 正式发布
```

### v2.8.0 (2026年2月)

```
2026-01 月初 - 开发启动
2026-01 月中 - Zero-Copy 默认启用实现
2026-01 月底 - v2.8.0-alpha 发布
2026-02 月初 - 充分测试
2026-02 月中 - v2.8.0 正式发布
```

---

## 🔍 需要进一步调查

1. **N-API 异常根本原因**
   - 为什么会频繁触发？
   - 是否与 Buffer Pool 设计有关？
   - 是否与多实例有关？

2. **Buffer Pool Hit Rate 低的根本原因**
   - V8 GC 延迟具体影响
   - 是否可以通过代码优化改善？
   - 自适应策略能提升多少？

3. **多实例场景测试**
   - 同时运行 2-5 个实例
   - 不同配置组合测试
   - 内存和性能影响评估

---

## 💬 结论

**推荐路径**:

1. **立即**: 暂停 "Zero-Copy 默认启用" 开发
2. **v2.7.0**: 聚焦自适应 Buffer Pool
3. **v2.8.0**: 基于 v2.7 的稳定性考虑默认启用

**理由**:

- ✅ 降低技术风险
- ✅ 每个版本专注一个核心特性
- ✅ 更容易测试和调试
- ✅ 给用户更平滑的升级路径
- ✅ v2.6 已经很优秀，不需要急于默认启用

---

**报告人**: GitHub Copilot  
**审核状态**: 待用户确认  
**下一步行动**: 根据用户反馈调整开发计划
