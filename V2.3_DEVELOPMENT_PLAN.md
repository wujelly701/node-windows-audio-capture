# v2.3.0 开发计划

**目标版本**: v2.3.0  
**主题**: 性能优化与设备选择  
**预计周期**: 4-6周  
**开始日期**: 2025-10-15  

---

## 🎯 核心目标

### 1. 设备选择功能 ⭐ **MVP优先**

**当前限制**: 只能捕获默认音频设备  
**目标**: 支持用户选择任意音频输出设备

#### 技术方案

```cpp
// C++ WASAPI层
class AudioDeviceEnumerator {
public:
  std::vector<AudioDeviceInfo> EnumerateOutputDevices();
  ComPtr<IMMDevice> GetDeviceById(const std::string& deviceId);
};

struct AudioDeviceInfo {
  std::string id;           // 设备ID
  std::string name;         // 设备名称（友好名称）
  std::string description;  // 设备描述
  bool isDefault;           // 是否为默认设备
  bool isActive;            // 是否在使用中
};

// N-API层
Napi::Array GetAudioDevices(const Napi::CallbackInfo& info);
void SetTargetDevice(const Napi::CallbackInfo& info);
```

#### JavaScript API设计

```javascript
const { AudioCapture, getAudioDevices } = require('node-windows-audio-capture');

// 1. 枚举所有音频输出设备
const devices = await getAudioDevices();
console.log(devices);
// [
//   { id: '{0.0.0.00000000}...', name: '扬声器 (Realtek)', isDefault: true, isActive: true },
//   { id: '{0.0.1.00000000}...', name: '耳机 (USB)', isDefault: false, isActive: false },
//   ...
// ]

// 2. 创建捕获实例时指定设备
const capture = new AudioCapture({
  deviceId: devices[1].id,  // 选择特定设备
  targetProcessId: 0        // 捕获该设备的所有音频
});

// 或使用默认设备
const capture2 = new AudioCapture({
  deviceId: null,  // null = 默认设备（当前行为）
  targetProcessId: 0
});
```

#### 任务分解

- [ ] **T2.3.1**: C++实现设备枚举（`src/wasapi/device_enumerator.cpp`）[8h]
- [ ] **T2.3.2**: N-API绑定（`src/napi/device_manager.cpp`）[6h]
- [ ] **T2.3.3**: JavaScript API封装（`lib/audio-capture.js`）[4h]
- [ ] **T2.3.4**: TypeScript类型定义（`index.d.ts`）[2h]
- [ ] **T2.3.5**: 单元测试（设备枚举、设备切换）[6h]
- [ ] **T2.3.6**: 集成测试（多设备场景）[4h]
- [ ] **T2.3.7**: 文档和示例（`examples/device-selection.js`）[3h]

**小计**: 33小时（约1周）

---

### 2. 降采样算法优化

**当前状态**: v2.2实现了simple/linear/sinc三种质量  
**目标**: 优化sinc算法，提升质量和性能

#### 优化方案

1. **使用更高效的窗函数**
   - 当前: Lanczos窗
   - 优化: Kaiser窗（可调β参数，更好的频率响应）

2. **SIMD优化**
   - 使用SSE/AVX指令集加速卷积运算
   - 批处理多个样本

3. **内存对齐**
   - 16字节对齐以利用SIMD
   - 减少cache miss

#### 预期提升

| 指标 | v2.2 | v2.3目标 | 提升 |
|------|------|---------|------|
| Sinc质量（THD+N） | 0.001% | 0.0005% | 50% ↑ |
| Sinc处理时间 | 8ms/秒 | 5ms/秒 | 37.5% ↓ |
| CPU占用 | ~8% | ~5% | 37.5% ↓ |

#### 任务分解

- [ ] **T2.3.8**: 研究Kaiser窗参数（文献调研）[4h]
- [ ] **T2.3.9**: 实现Kaiser窗函数（`lib/audio-resampler.js`）[6h]
- [ ] **T2.3.10**: SIMD优化探索（C++ Native模块）[12h]
- [ ] **T2.3.11**: 性能测试和对比[4h]
- [ ] **T2.3.12**: 音质测试（THD+N、SNR测量）[4h]
- [ ] **T2.3.13**: 文档更新[2h]

**小计**: 32小时（约1周）

---

### 3. 内存使用优化

**当前问题**: 每次格式转换都分配新Buffer  
**目标**: 减少内存分配，使用内存池

#### 优化方案

```javascript
class BufferPool {
  constructor(bufferSize, poolSize = 10) {
    this.bufferSize = bufferSize;
    this.pool = [];
    this.inUse = new Set();
    
    // 预分配buffer池
    for (let i = 0; i < poolSize; i++) {
      this.pool.push(Buffer.allocUnsafe(bufferSize));
    }
  }
  
  acquire() {
    if (this.pool.length > 0) {
      const buffer = this.pool.pop();
      this.inUse.add(buffer);
      return buffer;
    }
    // 池耗尽，动态分配
    const buffer = Buffer.allocUnsafe(this.bufferSize);
    this.inUse.add(buffer);
    return buffer;
  }
  
  release(buffer) {
    if (this.inUse.has(buffer)) {
      this.inUse.delete(buffer);
      if (this.pool.length < this.poolSize) {
        this.pool.push(buffer);
      }
    }
  }
}
```

#### 预期提升

| 指标 | v2.2 | v2.3目标 | 提升 |
|------|------|---------|------|
| 内存分配次数 | ~1000/秒 | ~10/秒 | 99% ↓ |
| GC暂停频率 | ~100ms/分钟 | ~20ms/分钟 | 80% ↓ |
| 内存占用 | ~50MB | ~30MB | 40% ↓ |

#### 任务分解

- [ ] **T2.3.14**: 实现BufferPool（`lib/buffer-pool.js`）[6h]
- [ ] **T2.3.15**: 集成到AudioResampler[4h]
- [ ] **T2.3.16**: 集成到AudioProcessingPipeline[4h]
- [ ] **T2.3.17**: 内存泄漏测试[4h]
- [ ] **T2.3.18**: 性能基准测试[3h]
- [ ] **T2.3.19**: 文档更新[2h]

**小计**: 23小时（约0.5周）

---

### 4. 多线程并行处理（可选）

**当前状态**: 单线程处理  
**目标**: 使用Worker Threads并行处理多个音频流

#### 技术方案

```javascript
const { Worker } = require('worker_threads');

class ParallelAudioProcessor {
  constructor(numWorkers = 2) {
    this.workers = [];
    this.taskQueue = [];
    
    for (let i = 0; i < numWorkers; i++) {
      const worker = new Worker('./audio-worker.js');
      this.workers.push(worker);
    }
  }
  
  async process(audioData) {
    // 分配到空闲worker
    const worker = this.getIdleWorker();
    return new Promise((resolve, reject) => {
      worker.postMessage({ type: 'process', data: audioData });
      worker.once('message', resolve);
      worker.once('error', reject);
    });
  }
}
```

#### 预期提升

仅在特定场景有效（同时处理多个音频源）：
- 单源场景: 无提升（反而可能降低性能）
- 多源场景: 50-80% 吞吐量提升

**建议**: MVP暂不实现，v2.4再考虑

#### 任务分解

- [ ] **T2.3.20**: Worker Threads POC[8h]
- [ ] **T2.3.21**: 实现ParallelAudioProcessor[12h]
- [ ] **T2.3.22**: 性能测试[4h]
- [ ] **T2.3.23**: 文档更新[2h]

**小计**: 26小时（约0.5周）- **可选任务**

---

## 📋 次要功能

### 5. 更多采样率支持

扩展支持的采样率：
- 当前: 48000Hz → 16000Hz
- 新增: 8000Hz, 11025Hz, 22050Hz, 24000Hz, 32000Hz, 44100Hz

**任务**: 3小时

### 6. 音频效果处理（可选）

实现基础音频效果：
- 降噪（Noise Gate）
- 增益控制（Gain）
- 均衡器（简单EQ）

**任务**: 16小时 - **v2.4考虑**

### 7. npm发布和CI/CD

- 配置自动npm发布
- 优化CI/CD流程
- 添加代码覆盖率报告

**任务**: 6小时

---

## 📅 开发时间表

### Week 1: 设备选择功能（MVP优先）
- Day 1-2: C++设备枚举实现
- Day 3: N-API绑定
- Day 4: JavaScript API和测试
- Day 5: 文档和示例

### Week 2: 降采样算法优化
- Day 1: Kaiser窗研究和实现
- Day 2-3: SIMD优化探索
- Day 4: 性能测试
- Day 5: 音质测试和文档

### Week 3: 内存优化
- Day 1: BufferPool实现
- Day 2: 集成到现有模块
- Day 3: 测试和基准
- Day 4-5: CI/CD配置和npm发布

### Week 4: 测试和发布
- Day 1-2: 完整回归测试
- Day 3: 文档整理
- Day 4: 发布准备
- Day 5: v2.3.0发布

---

## 🧪 测试计划

### 单元测试
- 设备枚举测试
- 设备切换测试
- 降采样质量测试
- 内存池测试

### 集成测试
- 多设备场景测试
- 长时间运行测试（内存泄漏检测）
- 性能基准测试

### 兼容性测试
- Windows 10/11
- Node.js 16/18/20/22
- 不同音频设备（Realtek、USB耳机、虚拟音频设备）

---

## 📊 成功指标

### 性能指标
- ✅ 设备选择功能100%可用
- ✅ Sinc降采样性能提升30%+
- ✅ 内存分配减少90%+
- ✅ 测试覆盖率保持85%+

### 质量指标
- ✅ 音质THD+N < 0.0005%
- ✅ 无内存泄漏
- ✅ 向后兼容v2.2

### 文档指标
- ✅ API文档完整
- ✅ 示例代码齐全
- ✅ FAQ更新

---

## 🔄 版本发布计划

### Alpha测试 (Week 3)
- 内部测试版
- 验证核心功能

### Beta测试 (Week 4 Day 1-3)
- 公开测试版
- 收集用户反馈

### 正式发布 (Week 4 Day 5)
- v2.3.0 Release
- npm发布
- GitHub Release

---

## 📝 文档更新清单

- [ ] README.md（路线图更新）
- [ ] docs/api.md（新增设备选择API）
- [ ] docs/V2.3_RELEASE_NOTES.md（发布说明）
- [ ] examples/device-selection.js（新示例）
- [ ] CHANGELOG.md（变更日志）

---

## 💡 风险与应对

### 风险1: SIMD优化复杂度高
- **概率**: 中
- **影响**: 延期1-2周
- **应对**: 降低优先级，v2.4再实现

### 风险2: 设备枚举兼容性问题
- **概率**: 低
- **影响**: 部分设备无法识别
- **应对**: 充分测试常见设备，提供fallback机制

### 风险3: 内存池实现复杂
- **概率**: 低
- **影响**: 延期几天
- **应对**: 使用成熟的开源库（如对象池模式）

---

**计划制定人**: GitHub Copilot  
**计划审核**: 待审核  
**计划批准**: 待批准
