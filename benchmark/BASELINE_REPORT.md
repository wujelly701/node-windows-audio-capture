# v2.4.0 性能基线报告

**测试日期**: 2025-10-15  
**版本**: v2.4.0  
**测试环境**:
- **Node.js**: v20.19.5
- **Platform**: Windows 10 x64
- **CPUs**: 16 cores
- **Memory**: 15.7GB

---

## 📊 测试概览

本报告记录了 v2.4.0 的性能基线数据，为 v2.5.0 性能优化提供对比基准。

### 测试范围

1. ✅ 降采样性能测试 (Resampling Benchmark)
2. ✅ 内存使用测试 (Memory Benchmark)
3. ⏸️ 吞吐量测试 (待实现)
4. ⏸️ 音频质量测试 (待实现)

---

## 1. 降采样性能测试

### 测试配置

- **输入**: 48kHz, 2通道, Float32
- **输出**: 16kHz, 2通道
- **测试时长**: 1秒音频
- **迭代次数**: 100次
- **测试数据**: 正弦波 (1kHz) + 白噪声

### 测试结果

| 质量级别 | 平均时间 | 最小/最大 | CPU 占用 | 内存占用 | 压缩比 |
|---------|---------|----------|---------|---------|--------|
| **simple** | 1.49ms | 1.25ms / 3.08ms | 0.1% | -0.88MB | 6:1 |
| **linear** | 1.43ms | 1.28ms / 2.54ms | 0.1% | -0.52MB | 6:1 |
| **sinc** | 4.89ms | 4.59ms / 5.53ms | 0.5% | -0.69MB | 6:1 |

### 关键指标

**处理速度**:
- Simple: ~672 倍实时 (1秒音频需 1.49ms 处理)
- Linear: ~699 倍实时 (1秒音频需 1.43ms 处理)
- Sinc: ~204 倍实时 (1秒音频需 4.89ms 处理)

**性能稳定性**:
- Simple: 标准差 0.18ms, CV = 12.1%
- Linear: 标准差 0.16ms, CV = 11.2%
- Sinc: 标准差 0.20ms, CV = 4.1% (最稳定)

**内存效率**:
- 所有质量级别内存占用为负值，说明 GC 回收良好
- 无明显内存泄漏

### 发现与分析

✅ **优点**:
1. 处理速度极快 (200-700倍实时)
2. CPU 占用极低 (0.1-0.5%)
3. 内存管理良好，无泄漏

⚠️ **待改进**:
1. THD+N 测试未实现 (显示 NaN)
2. Sinc 插值性能有提升空间 (3.4倍慢于 linear)
3. 当前 Sinc 实现可能不是真正的 Kaiser 窗口插值

**v2.5.0 优化目标**:
- 实现高质量 Kaiser 窗口 Sinc 插值
- 保持或提升处理速度
- 将 Sinc THD+N 降至 < 0.01%

---

## 2. 内存使用测试

### 测试配置

- **测试时长**: 30秒
- **数据速率**: 100 packets/sec (模拟实时音频)
- **每包大小**: 3840 bytes (10ms @ 48kHz stereo float32)
- **处理管道**: AudioProcessingPipeline ('china-asr')

### 测试结果

**内存使用**:
- **初始 Heap**: 3.35MB
- **最终 Heap**: 3.52MB
- **Heap 增长**: 0.17MB
- **RSS 增长**: 1.02MB

**增长率**:
- **Heap 增长率**: 16.07 MB/hour
- **RSS 增长率**: N/A

**处理统计**:
- **总处理包数**: 1900 packets
- **总处理数据**: 0.59MB
- **Buffer 分配速率**: 289,743 ops/sec

### 内存快照分析

| 时间 | Heap Used | RSS | Packets |
|------|-----------|-----|---------|
| 0s   | 3.35MB    | 32.05MB | 0 |
| 1.6s | 3.64MB    | 33.86MB | 100 |
| 15.6s | 3.45MB   | 32.91MB | 1000 |
| 29.6s | 3.52MB   | 33.07MB | 1900 |

**内存趋势**:
- 前 1.6秒快速增长 (+0.29MB heap)
- 之后保持稳定，轻微波动
- GC 定期回收，无累积增长

### 发现与分析

✅ **优点**:
1. 内存占用极低 (~3.5MB heap)
2. 长时间运行稳定
3. GC 表现良好

⚠️ **可能存在的问题**:
1. 增长率 16MB/hour 略高（阈值 < 1MB/hour）
2. 初期内存分配较多（前 1.6秒）
3. 每次 Buffer.alloc() 都会触发新分配

**v2.5.0 优化目标**:
- 实现 Buffer 池化，减少分配
- 降低增长率至 < 1MB/hour
- 减少初期内存分配峰值

---

## 3. Buffer 池性能测试

### 当前性能 (无池化)

- **分配速率**: 289,743 ops/sec
- **内存占用**: 0.65MB (10,000次分配)
- **平均耗时**: 34.51ms

### v2.5.0 目标

- **分配速率**: > 500,000 ops/sec (提升 70%+)
- **内存占用**: < 0.3MB (减少 50%+)
- **平均耗时**: < 20ms (减少 40%+)

---

## 4. 综合性能评估

### v2.4.0 性能概况

| 指标 | 当前值 | 性能等级 |
|------|--------|---------|
| 降采样速度 (linear) | 1.43ms/s | ⭐⭐⭐⭐⭐ 优秀 |
| CPU 占用 | 0.1-0.5% | ⭐⭐⭐⭐⭐ 极低 |
| 内存占用 | 3.5MB | ⭐⭐⭐⭐⭐ 极低 |
| 内存增长率 | 16MB/h | ⭐⭐⭐ 一般 |
| 音频质量 (THD+N) | 未测试 | ⭐⭐ 待评估 |
| Buffer 分配 | 290K ops/s | ⭐⭐⭐ 一般 |

**总体评价**: ⭐⭐⭐⭐ (4/5)

v2.4.0 在速度和资源占用方面表现优秀，但在内存管理和音频质量测量方面仍有优化空间。

---

## 5. v2.5.0 优化目标

### Phase 1: 降采样算法优化

| 指标 | v2.4.0 基线 | v2.5.0 目标 | 提升幅度 |
|------|------------|------------|---------|
| Sinc 处理时间 | 4.89ms | < 3.0ms | 38%+ ⬇️ |
| THD+N | 未测试 | < 0.01% | 新增 |
| CPU 占用 | 0.5% | < 0.3% | 40% ⬇️ |

**关键任务**:
1. 实现 Kaiser 窗口 Sinc 插值
2. 添加 FFT 分析进行 THD+N 测量
3. SIMD 向量化优化（可选）

### Phase 2: 内存优化

| 指标 | v2.4.0 基线 | v2.5.0 目标 | 提升幅度 |
|------|------------|------------|---------|
| 内存增长率 | 16MB/h | < 1MB/h | 94%+ ⬇️ |
| Buffer 分配速率 | 290K ops/s | > 500K ops/s | 72%+ ⬆️ |
| Heap 峰值占用 | 3.64MB | < 2.5MB | 31% ⬇️ |

**关键任务**:
1. 实现 Buffer 池 (4KB, 8KB, 16KB)
2. 减少中间 Buffer 拷贝
3. 优化初始化阶段内存分配

### Phase 3: 多线程并行处理

| 指标 | v2.4.0 基线 | v2.5.0 目标 | 提升幅度 |
|------|------------|------------|---------|
| 吞吐量 | 1x 实时 | 2-4x 实时 | 2-4x ⬆️ |
| 延迟增加 | N/A | < 20ms | 新增 |
| CPU 利用率 | < 1% | > 70% | 多核利用 |

**关键任务**:
1. Worker 线程池 (2-4 threads)
2. 任务分片和负载均衡
3. 减少线程间通信开销

---

## 6. 测试数据文件

### 生成的文件

1. **baseline-resampling-2025-10-14T16-30-12-105Z.json**
   - 降采样性能测试原始数据
   - 包含所有质量级别详细数据

2. **baseline-memory-2025-10-14T16-31-41-867Z.json**
   - 内存使用测试原始数据
   - 包含完整内存快照序列

### 文件位置

```
benchmark/
├── baseline-resampling-2025-10-14T16-30-12-105Z.json
├── baseline-memory-2025-10-14T16-31-41-867Z.json
└── BASELINE_REPORT.md (本文件)
```

---

## 7. 后续行动计划

### 立即行动 (Phase 0 完成)

- [x] 运行降采样基准测试
- [x] 运行内存基准测试
- [x] 生成基线报告
- [ ] 实现吞吐量基准测试
- [ ] 实现音频质量基准测试 (FFT + THD+N)

### Phase 1 准备 (10月18日开始)

- [ ] 研究 Kaiser 窗口参数优化
- [ ] 设计 Sinc 插值系数预计算方案
- [ ] 实现 FFT 分析工具
- [ ] 准备音频质量对比测试数据集

---

## 8. 参考资料

### 性能测试方法

- **CPU 占用计算**: (处理时间 / 音频时长) × 100%
- **实时倍率**: 音频时长 / 处理时间
- **内存增长率**: 线性回归斜率 × 3600 (MB/hour)

### 质量评估标准

- **THD+N**: Total Harmonic Distortion + Noise
  - Excellent: < 0.01%
  - Good: < 0.05%
  - Acceptable: < 0.1%

- **SNR**: Signal-to-Noise Ratio
  - Excellent: > 90dB
  - Good: > 80dB
  - Acceptable: > 70dB

---

## 9. 附录

### A. 测试命令

```bash
# 降采样性能测试
node benchmark/resampling-benchmark.js

# 内存测试 (需要 --expose-gc)
node --expose-gc benchmark/memory-benchmark.js

# 吞吐量测试 (待实现)
node benchmark/throughput-benchmark.js

# 音频质量测试 (待实现)
node benchmark/audio-quality-benchmark.js
```

### B. 系统信息

```
Node.js: v20.19.5
npm: 9.x
OS: Windows 10 x64
CPU: 16 cores
RAM: 15.7GB
```

### C. 依赖版本

```json
{
  "node-windows-audio-capture": "2.4.0",
  "audio-resampler": "内置",
  "audio-processing-pipeline": "内置"
}
```

---

**报告生成时间**: 2025-10-15 14:35  
**报告作者**: v2.5.0 Performance Optimization Team  
**版本**: 1.0
