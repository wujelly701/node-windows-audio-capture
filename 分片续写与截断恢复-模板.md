## 分片续写与截断恢复（用于 Copilot Chat / ChatGPT 的 prompt 文档）

本文件收集并格式化了在 Copilot Chat（或任意聊天式 LLM 工具）中遇到“Sorry, the response hit the length limit. Please rephrase your prompt.”时的可执行解决方法、会话契约和可直接复制粘贴的 prompt 模板。把下面的模板直接粘到 Copilot Chat 中并按指示替换方括号内容即可。

### 目标
- 可靠继续生成被截断的长文档（第三份文档或更长内容），避免重复或丢失内容。
- 提供“会话契约 + 分片输出 + 截断恢复”一套流程，便于工程化使用或手动操作。

---

## 使用总览（4 步）
1. 发送“会话契约”消息，说明要按分片输出与分隔符规则（一次性发）。
2. 收到第 1 片后保存，并按顺序发送“继续”模板请求下一片。
3. 若收到“Sorry, the response hit the length limit”或模型被截断，使用“截断恢复模板”并粘上你已收到的最后 200–400 字（或最后 2–3 行）以保证衔接。
4. 全部片段接收完毕后，使用“合并校对”请求模型把片段合并为最终文档并修正重复/断句问题。

---

## 1) 会话契约（必先发送）
（目的：约束模型输出格式与分片规则）

```
会话契约：我要你把“第三份文档（主题：<在此填主题>）”分成 N 个片段输出（N = <在此填，例如10>）。请严格遵守下列规则：

1) 只输出片段内容，格式必须严格如下：
===DOC_PART_START [i/N]===
(正文)
===DOC_PART_END [i/N]===

2) 每个片段约 500–900 字（或指定字数），不要超过 1000 字。
3) 每片必须在结尾处留至少 2–3 行完整句子（以便衔接），如果因为长度限制被截断，请不要自行补说明或重述。
4) 输出第 1 片（===DOC_PART_START [1/N]===）并停止。收到“继续”指令后再输出下一片。
5) 如果在任何时刻你被截断或响应受限，请在返回的最后一行写上：===TRUNCATED=== 并保留最后至少 3 行内容以便恢复。

主题与风格：<在此填主题和风格，例如“主题：产品使用手册；风格：正式、技术、中文”>
总目标：大约 <在此填总字数，例如 8000 字>，分 N = <在此填> 片完成。
```

---

## 2) 请求下一片（每次发送）

```
继续：请输出下一片（===DOC_PART_START [<i+1>/<N>]===），保持同样风格与编号规则，只输出片段正文与分隔符，不要其它说明。
```

---

## 3) 截断恢复模板（当出现“Sorry, the response hit the length limit”或你发现输出被截断时）

把你已经收到的“最后 200–400 字”或“最后 2–3 行”粘上，然后发送下面的恢复提示。

```
恢复并继续：上次输出被截断。下面是我收到的最后部分，请从该处之后继续，不要重复已收到的内容。只输出继续的正文片段并使用相同的分隔符格式。

--- 我收到的上次末尾（请粘贴最后 2–3 行或最后 200–400 字） ---
「在这里粘上你最后实际收到的文本结尾」
--- 结束 ---

请从该处之后继续输出下一片（例如 ===DOC_PART_START [k/N]===），并确保在片段末尾保留至少 3 行完整句子以便下次衔接。如果再次被截断，重复本恢复流程。
```

注意：每次续写都粘上上一次返回的“最后 200–400 字”能显著降低重复与不连贯。

---

## 3.1) 未知总长度的会话契约（当你不确定文档总字数/片数时）

如果你无法预先知道第三份文档的总字数或总片数，使用下面的“动态继续直到完成”契约。该方法不要求事先指定 N，而是让模型在每片结尾写上进度标记并在完成时输出特殊结束标记 `===DOC_COMPLETE===`。

```
动态会话契约：请把“第三份文档”分成若干片段输出。请严格遵守下列规则：

1) 只输出片段内容，格式必须严格如下：
===DOC_PART_START [i]===
(正文)
===DOC_PART_END [i]===

其中 [i] 是片段序号（从 1 开始，自增）。
2) 每个片段约 500–900 字（或指定范围），不要超过 1000 字。
3) 每片必须在结尾处留至少 2–3 行完整句子（以便衔接）。
4) 如果你在生成过程中被截断或遇到长度限制，请在返回的最后一行写上：===TRUNCATED=== 并保留最后至少 3 行内容以便恢复。
5) 当整篇文档写完时，最后一片在 `===DOC_PART_END [i]===` 之后另起一行输出：===DOC_COMPLETE=== 以标示文档结束。

主题与风格：<在此填主题和风格，例如“主题：产品使用手册；风格：正式、技术、中文”>
总目标（可选）：如果你有一个大致目标字数，可以写上例如“目标约 8000 字”，但这不是强制项。
```

使用要点：
- 用每片的序号 `[i]` 跟踪进度（不用事先知道总片数）。
- 在收到某片时，如果该片末尾包含 `===TRUNCATED===`，则使用原来的“截断恢复模板”并把最后 200–400 字粘上继续；如果未包含 `===TRUNCATED===` 但你怀疑仍未完成，可以发送“继续”请求，模型会输出下一个 `[i+1]` 片，直到模型在最后输出 `===DOC_COMPLETE===`。

示例：
1) 发送动态会话契约（上面那段）。
2) 模型输出 `===DOC_PART_START [1]===...===DOC_PART_END [1]===`。保存并检查末尾是否有 `===TRUNCATED===`。
3) 发送“继续：请输出下一片（===DOC_PART_START [2]===）”。
4) 重复直到收到 `===DOC_COMPLETE===`。

## 3.2) 直接创建片段文件（便于本地拼接）

如果你偏好模型直接输出每个片段为一个“可保存的文件内容”，便于你在本地把片段直接另存为独立文件并手工拼接，请使用下面的文件化输出契约。该契约会让模型为每片输出一个明确的文件名说明与边界，输出时不带多余的说明文字，便于复制/保存。

文件化输出契约（模板）——把它粘给 Copilot Chat：

```
文件化输出契约：请把“第三份文档（主题：<在此填主题>）”拆成若干片段，每个片段输出为一个“文件内容”，格式必须严格如下：

===DOC_FILE_START [i] filename: <filename>===
(文件正文)
===DOC_FILE_END [i]===

说明：
- [i] 是片段序号，从 1 开始自增。
- <filename> 为建议保存的文件名（例如 part-001.md、part-002.md 或 01-章节名.md）。文件名中请避免使用特殊字符。模型应在 filename 字段使用短横线或下划线替代空格。
- 每个文件约 500–900 字，不超过 1000 字。
- 每个文件结尾应保留至少 2–3 行完整句子以便衔接。
- 若该文件被截断，请在文件末尾添加一行：===TRUNCATED=== 并保留最后至少 3 行内容以便恢复。
- 当所有文件都完成后，模型在最后一片的结束标记后另起一行输出：===DOC_COMPLETE===

主题与风格：<在此填主题和风格，例如“主题：产品使用手册；风格：正式、技术、中文”>
```

示例输出（模型应该只输出下面格式，不要额外说明）：

```
===DOC_FILE_START [1] filename: part-001.md===
# 第1部分 标题

（这里是正文…）

===DOC_FILE_END [1]===
```

请求下一文件（复制粘贴发送）：

```
继续：请输出下一文件（===DOC_FILE_START [<i+1>] filename: part-00< i+1 >.md===），只输出文件区块与文件名，不要其它说明。
```

如果出现截断或“Sorry, the response hit the length limit”，请使用下面的恢复模板并粘上你已保存的该片段末尾 200–400 字（或最后 2–3 行）：

```
恢复并继续（文件化输出）：上次文件 <filename> 被截断。下面是我收到并已保存的该文件末尾，请从该处之后继续并把下一个片段输出为新的文件块：

--- 我已保存的 <filename> 末尾（请粘贴最后 2–3 行或最后 200–400 字） ---
「在这里粘上你最后实际收到并保存的文本结尾」
--- 结束 ---

请从该处之后继续，并输出下一个文件区块，例如：
===DOC_FILE_START [k] filename: part-00k.md===
(正文)
===DOC_FILE_END [k]===

如果继续片段也被截断，请重复本恢复流程。
```

本地拼接小提示（PowerShell）：将生成的文件按序合并为一个文件（确保文件名按序排列）：

```powershell
# 假设文件名为 part-001.md, part-002.md, ... 在当前目录
Get-Content .\part-001.md, .\part-002.md, .\part-003.md | Set-Content .\merged.md

# 或通配合并（按字母顺序，确保文件名按序）
Get-ChildItem -Filter "part-*.md" | Sort-Object Name | Get-Content | Set-Content .\merged.md
```

保存约定建议：
- 使用 `part-001.md` 这类有序编号的文件名能确保按字母序直接拼接；
- 如果文件包含 Markdown 标题（例如 `# 第1部分`），最终合并后再运行一次“合并校对”步骤，要求模型检查并修正重复标题或断句问题。

使用场景：当你想把每个片段单独保存为文件、便于版本控制或逐片审阅时非常有用。



## 4) 分块/分章生成（替代方案，适合非常长或结构化文档）

流程：
1. 先让模型输出文档的详细目录（6–12 章，每章写明目标字数）。
2. 逐章请求生成正文（例如“生成第 3 章，约 600 字”）。
3. 每章单独保存，最后请求模型合并并校对一次。

会话示例（请求目录）：

```
请为“第三份文档（主题：<主题>）”生成一个详细目录，列出 6–10 个章节并在每章后注明目标字数（例如 400–800 字），只输出目录。
```

然后按章节生成：

```
请根据目录的第 3 章“<章名>”生成约 700 字的正文，保留小节编号和示例表格（如果适用），不要生成其他章节或摘要。
```

---

## 5) 合并校对（片段全部收集完后）

```
合并校对：我已经收到全部 N 个片段（1..N）。请把它们合并为一份连贯文档，修正可能的重复句、段落断裂、编号问题和小型语法错误。只输出合并后的正文，不要再分片或解释。
```

---

## 6) 快速恢复 & 额外小贴士
- 每次续写时粘上“最后 1–3 行”或“最后 200–400 字”的上下文，能显著减少重复与语义不连贯。
- 要求“只输出正文/只输出片段”可以避免模型在每次续写时加入解释性文字。
- 在会话契约中要求模型在被截断时输出 `===TRUNCATED===`，便于检测是否需要恢复。
- 如果 Copilot Chat 支持选择模型上下文大小或“保持上下文”选项，优先选用更大上下文或开启相关选项。
- 若反复失败，切换到“分章生成”策略并逐章合并。

---

## 7) 实际发送顺序建议（最小操作）
1. 发送“会话契约”（只发一次）。
2. 收到第 1 片后保存并发送“继续”模板请求第 2 片。重复此步骤直至所有片段完成。若任何片段被截断，用截断恢复模板粘上末尾上下文继续。 
3. 全部片段完成后发送“合并校对”。

---

## 8) 版本与维护建议
- 文件名：`分片续写与截断恢复-模板.md`（已保存到 `开发文档/软件开发prompt/`）。
- 如果你有针对 Copilot Chat 的特殊限制（例如最大响应长度、是否支持多轮上下文保留），请把这些限制记录在本文件开头的注释中以便未来调整分片大小或策略。

---

如果你希望，我可以：
- 把这个文档也生成一个英文版（`en.md`），或
- 根据你的典型文档长度（例如 8000 字）把示例 N 值和每片目标字数填好并生成一个可直接用的会话契约文本供你复制。

（文档结束）
