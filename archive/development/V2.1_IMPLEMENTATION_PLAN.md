# v2.1 åŠ¨æ€éŸ³é¢‘ä¼šè¯é™éŸ³åŠŸèƒ½ - å®æ–½è®¡åˆ’

## ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯

**ç‰ˆæœ¬**: v2.1.0  
**ç›®æ ‡**: æå‡éŸ³é¢‘çº¯å‡€åº¦ä» 60% â†’ 90%  
**å¼€å‘æ—¶é—´**: é¢„è®¡ 1-2 å¤©  
**å‘å¸ƒæ—¥æœŸ**: 2025-10-14  

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

### é—®é¢˜æè¿°

**v2.0.0 çš„é™åˆ¶**:
```
åœºæ™¯: ç”¨æˆ·ä½¿ç”¨Chromeçœ‹YouTube + QQéŸ³ä¹åŒæ—¶æ’­æ”¾

å½“å‰æ•ˆæœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chrome (YouTube) â™ªâ™ªâ™ª          â”‚ â† ç›®æ ‡éŸ³é¢‘
â”‚ QQéŸ³ä¹ (èƒŒæ™¯éŸ³ä¹) â™«â™«â™«         â”‚ â† å™ªéŸ³
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•è·ç»“æœ: YouTube + QQéŸ³ä¹æ··åˆ â”‚ â† ä¸çº¯å‡€ (60%)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**v2.1.0 ç›®æ ‡**:
```
åœºæ™¯: åŒä¸Š

v2.1æ•ˆæœ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chrome (YouTube) â™ªâ™ªâ™ª          â”‚ â† æ•è·
â”‚ QQéŸ³ä¹ (èƒŒæ™¯éŸ³ä¹) ğŸ”‡ è‡ªåŠ¨é™éŸ³  â”‚ â† è¢«å±è”½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•è·ç»“æœ: åªæœ‰YouTube         â”‚ â† çº¯å‡€ (90%)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒå®ç°æ€è·¯

```cpp
// v2.0: ç®€å•æ£€æµ‹
if (IsTargetProcessPlayingAudio(targetPid)) {
    CaptureSystemAudio();  // æ•è·æ‰€æœ‰ï¼ˆåŒ…æ‹¬å™ªéŸ³ï¼‰
} else {
    OutputSilence();
}

// v2.1: åŠ¨æ€é™éŸ³
EnumerateAllAudioSessions();
foreach (session in sessions) {
    if (session.processId == targetPid) {
        // ä¿æŒç›®æ ‡è¿›ç¨‹ä¸é™éŸ³
        session.SetMute(false);
    } else if (!IsInAllowList(session.processId)) {
        // é™éŸ³å…¶ä»–è¿›ç¨‹
        session.SetMute(true);
    }
}
CaptureSystemAudio();  // ç°åœ¨åªæœ‰ç›®æ ‡è¿›ç¨‹éŸ³é¢‘
```

### APIè®¾è®¡

```javascript
// JavaScript API
const processor = new AudioProcessor();

// æ–¹å¼1: åˆå§‹åŒ–æ—¶é…ç½®
processor.initializeWithProcessFilter(targetPid, {
    muteOtherProcesses: true,    // è‡ªåŠ¨é™éŸ³å…¶ä»–è¿›ç¨‹
    allowList: [1234, 5678],     // ç™½åå•ï¼ˆä¸é™éŸ³ï¼‰
    blockList: [9999]            // é»‘åå•ï¼ˆå¼ºåˆ¶é™éŸ³ï¼‰
});

// æ–¹å¼2: è¿è¡Œæ—¶é…ç½®
processor.setMuteOtherProcesses(true);
processor.setAllowList([1234, 5678]);
processor.setBlockList([9999]);

// æŸ¥è¯¢å½“å‰çŠ¶æ€
const isMuting = processor.isMutingOtherProcesses();
const allowList = processor.getAllowList();
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### Step 1: æ‰©å±• AudioSessionManager ç±» âœ“

**æ–‡ä»¶**: `src/wasapi/audio_session_manager.h`

```cpp
class AudioSessionManager {
public:
    // æ–°å¢æ–¹æ³•
    bool MuteAllExcept(DWORD targetPid, 
                       const std::vector<DWORD>& allowList);
    bool UnmuteAll();
    bool SaveMuteStates();    // ä¿å­˜åŸå§‹é™éŸ³çŠ¶æ€
    bool RestoreMuteStates(); // æ¢å¤åŸå§‹é™éŸ³çŠ¶æ€
    
private:
    // æ–°å¢æˆå‘˜
    std::map<DWORD, bool> originalMuteStates_;  // PID -> åŸå§‹é™éŸ³çŠ¶æ€
    bool isManagingMuteStates_ = false;
};
```

**æ–‡ä»¶**: `src/wasapi/audio_session_manager.cpp`

```cpp
bool AudioSessionManager::MuteAllExcept(
    DWORD targetPid,
    const std::vector<DWORD>& allowList) {
    
    if (!sessionManager_) return false;
    
    // 1. ä¿å­˜åŸå§‹çŠ¶æ€
    if (!isManagingMuteStates_) {
        SaveMuteStates();
        isManagingMuteStates_ = true;
    }
    
    // 2. æšä¸¾æ‰€æœ‰ä¼šè¯
    auto sessions = EnumerateSessions();
    
    // 3. åº”ç”¨é™éŸ³è§„åˆ™
    for (const auto& session : sessions) {
        bool shouldMute = true;
        
        // ç›®æ ‡è¿›ç¨‹ä¸é™éŸ³
        if (session.processId == targetPid) {
            shouldMute = false;
        }
        // ç™½åå•ä¸é™éŸ³
        else if (std::find(allowList.begin(), allowList.end(), 
                          session.processId) != allowList.end()) {
            shouldMute = false;
        }
        
        // åº”ç”¨é™éŸ³
        SetProcessMute(session.processId, shouldMute);
    }
    
    return true;
}

bool AudioSessionManager::UnmuteAll() {
    return RestoreMuteStates();
}
```

**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

---

### Step 2: AudioClient é›†æˆåŠ¨æ€é™éŸ³ âœ“

**æ–‡ä»¶**: `src/wasapi/audio_client.h`

```cpp
class AudioClient {
public:
    // æ‰©å±•åˆå§‹åŒ–æ–¹æ³•
    struct ProcessFilterOptions {
        bool muteOtherProcesses = false;
        std::vector<DWORD> allowList;
        std::vector<DWORD> blockList;
    };
    
    bool InitializeWithProcessFilter(
        DWORD processId, 
        const ProcessFilterOptions& options = {});
    
    // è¿è¡Œæ—¶é…ç½®
    void SetMuteOtherProcesses(bool enable);
    void SetAllowList(const std::vector<DWORD>& pids);
    void SetBlockList(const std::vector<DWORD>& pids);
    
    bool IsMutingOtherProcesses() const;
    
private:
    ProcessFilterOptions filterOptions_;
    void ApplyMuteControl();  // åº”ç”¨é™éŸ³æ§åˆ¶
};
```

**æ–‡ä»¶**: `src/wasapi/audio_client.cpp`

```cpp
bool AudioClient::InitializeWithProcessFilter(
    DWORD processId,
    const ProcessFilterOptions& options) {
    
    // 1. æ ‡å‡†åˆå§‹åŒ–
    if (!Initialize(params)) return false;
    
    // 2. åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨
    if (!sessionManager_->Initialize(device_.Get())) return false;
    
    // 3. ä¿å­˜é…ç½®
    filterProcessId_ = processId;
    filterOptions_ = options;
    
    // 4. ç«‹å³åº”ç”¨é™éŸ³æ§åˆ¶
    if (filterOptions_.muteOtherProcesses) {
        ApplyMuteControl();
    }
    
    return true;
}

void AudioClient::ApplyMuteControl() {
    if (!filterOptions_.muteOtherProcesses) return;
    
    // åˆå¹¶ç™½åå•å’Œå…è®¸åˆ—è¡¨
    std::vector<DWORD> allowList = filterOptions_.allowList;
    
    // åº”ç”¨é™éŸ³
    sessionManager_->MuteAllExcept(filterProcessId_, allowList);
}

void AudioClient::SetMuteOtherProcesses(bool enable) {
    filterOptions_.muteOtherProcesses = enable;
    
    if (enable) {
        ApplyMuteControl();
    } else {
        sessionManager_->UnmuteAll();
    }
}
```

**é¢„è®¡æ—¶é—´**: 2-3å°æ—¶

---

### Step 3: æ›´æ–° JavaScript ç»‘å®š âœ“

**æ–‡ä»¶**: `src/napi/audio_processor.cpp`

```cpp
// æ–°å¢æ–¹æ³•ç»‘å®š
Napi::Value AudioProcessor::InitializeWithProcessFilter(
    const Napi::CallbackInfo& info) {
    
    Napi::Env env = info.Env();
    
    // å‚æ•°1: processId (å¿…éœ€)
    if (info.Length() < 1) {
        throw Napi::TypeError::New(env, "processId required");
    }
    DWORD processId = info[0].As<Napi::Number>().Uint32Value();
    
    // å‚æ•°2: options (å¯é€‰)
    AudioClient::ProcessFilterOptions options;
    if (info.Length() >= 2 && info[1].IsObject()) {
        Napi::Object opts = info[1].As<Napi::Object>();
        
        // muteOtherProcesses
        if (opts.Has("muteOtherProcesses")) {
            options.muteOtherProcesses = 
                opts.Get("muteOtherProcesses").As<Napi::Boolean>();
        }
        
        // allowList
        if (opts.Has("allowList") && 
            opts.Get("allowList").IsArray()) {
            Napi::Array arr = opts.Get("allowList").As<Napi::Array>();
            for (uint32_t i = 0; i < arr.Length(); i++) {
                options.allowList.push_back(
                    arr.Get(i).As<Napi::Number>().Uint32Value());
            }
        }
        
        // blockList
        if (opts.Has("blockList") && 
            opts.Get("blockList").IsArray()) {
            Napi::Array arr = opts.Get("blockList").As<Napi::Array>();
            for (uint32_t i = 0; i < arr.Length(); i++) {
                options.blockList.push_back(
                    arr.Get(i).As<Napi::Number>().Uint32Value());
            }
        }
    }
    
    // è°ƒç”¨C++æ–¹æ³•
    bool success = audioClient_->InitializeWithProcessFilter(
        processId, options);
    
    return Napi::Boolean::New(env, success);
}

// è¿è¡Œæ—¶é…ç½®æ–¹æ³•
Napi::Value AudioProcessor::SetMuteOtherProcesses(
    const Napi::CallbackInfo& info) {
    
    bool enable = info[0].As<Napi::Boolean>();
    audioClient_->SetMuteOtherProcesses(enable);
    return info.Env().Undefined();
}

// æ³¨å†Œæ–¹æ³•
Napi::Object Init(Napi::Env env, Napi::Object exports) {
    // ... ç°æœ‰ä»£ç  ...
    
    // æ·»åŠ æ–°æ–¹æ³•
    InstanceMethod("setMuteOtherProcesses", 
                   &AudioProcessor::SetMuteOtherProcesses),
    InstanceMethod("setAllowList", 
                   &AudioProcessor::SetAllowList),
    InstanceMethod("setBlockList", 
                   &AudioProcessor::SetBlockList),
    InstanceMethod("isMutingOtherProcesses", 
                   &AudioProcessor::IsMutingOtherProcesses),
}
```

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

### Step 4: ç¼–å†™æµ‹è¯•ç”¨ä¾‹ âœ“

**æ–‡ä»¶**: `test-v2.1-mute-control.js`

```javascript
const { AudioProcessor } = require('./build/Release/audio_addon.node');

console.log('ğŸ§ª v2.1 åŠ¨æ€é™éŸ³æ§åˆ¶æµ‹è¯•\n');

// 1. æŸ¥æ‰¾ç›®æ ‡è¿›ç¨‹å’Œå¹²æ‰°è¿›ç¨‹
function findProcessByName(sessions, name) {
    return sessions.find(s => 
        s.displayName.toLowerCase().includes(name.toLowerCase()));
}

async function testMuteControl() {
    const processor = new AudioProcessor();
    
    try {
        // æšä¸¾ä¼šè¯
        const sessions = processor.enumerateAudioSessions();
        console.log('ğŸ“‹ å½“å‰éŸ³é¢‘ä¼šè¯:');
        sessions.forEach(s => {
            console.log(`  - ${s.displayName} (PID: ${s.processId})`);
        });
        
        // æŸ¥æ‰¾Chromeå’ŒQQéŸ³ä¹
        const chrome = findProcessByName(sessions, 'chrome');
        const qqmusic = findProcessByName(sessions, 'qqmusic');
        
        if (!chrome) {
            console.log('âš ï¸ æœªæ‰¾åˆ°Chromeï¼Œè¯·æ‰“å¼€YouTubeè§†é¢‘');
            return;
        }
        
        console.log(`\nâœ… ç›®æ ‡è¿›ç¨‹: ${chrome.displayName} (${chrome.processId})`);
        if (qqmusic) {
            console.log(`âœ… å¹²æ‰°è¿›ç¨‹: ${qqmusic.displayName} (${qqmusic.processId})`);
        }
        
        // æµ‹è¯•1: ä¸å¯ç”¨é™éŸ³æ§åˆ¶ï¼ˆv2.0è¡Œä¸ºï¼‰
        console.log('\n\nğŸ“Š æµ‹è¯•1: v2.0æ¨¡å¼ï¼ˆä¸é™éŸ³å…¶ä»–è¿›ç¨‹ï¼‰');
        console.log('   è¯·åœ¨Chromeæ’­æ”¾è§†é¢‘ï¼ŒåŒæ—¶æ’­æ”¾QQéŸ³ä¹');
        console.log('   é¢„æœŸ: æ•è·åˆ°æ··åˆéŸ³é¢‘\n');
        
        processor.initializeWithProcessFilter(chrome.processId);
        processor.start();
        
        await sleep(5000);
        
        processor.stop();
        console.log('âœ… æµ‹è¯•1å®Œæˆ');
        
        // æµ‹è¯•2: å¯ç”¨é™éŸ³æ§åˆ¶ï¼ˆv2.1è¡Œä¸ºï¼‰
        console.log('\n\nğŸ“Š æµ‹è¯•2: v2.1æ¨¡å¼ï¼ˆé™éŸ³å…¶ä»–è¿›ç¨‹ï¼‰');
        console.log('   ä¿æŒChromeå’ŒQQéŸ³ä¹æ’­æ”¾');
        console.log('   é¢„æœŸ: åªæ•è·ChromeéŸ³é¢‘ï¼ŒQQè¢«é™éŸ³\n');
        
        processor.initializeWithProcessFilter(chrome.processId, {
            muteOtherProcesses: true
        });
        processor.start();
        
        await sleep(5000);
        
        processor.stop();
        console.log('âœ… æµ‹è¯•2å®Œæˆ');
        
        // æµ‹è¯•3: ç™½åå•åŠŸèƒ½
        if (qqmusic) {
            console.log('\n\nğŸ“Š æµ‹è¯•3: ç™½åå•åŠŸèƒ½');
            console.log('   å°†QQéŸ³ä¹åŠ å…¥ç™½åå•');
            console.log('   é¢„æœŸ: Chromeå’ŒQQéŸ³ä¹éƒ½ä¸è¢«é™éŸ³\n');
            
            processor.initializeWithProcessFilter(chrome.processId, {
                muteOtherProcesses: true,
                allowList: [qqmusic.processId]
            });
            processor.start();
            
            await sleep(5000);
            
            processor.stop();
            console.log('âœ… æµ‹è¯•3å®Œæˆ');
        }
        
        // æµ‹è¯•4: è¿è¡Œæ—¶åˆ‡æ¢
        console.log('\n\nğŸ“Š æµ‹è¯•4: è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢');
        
        processor.initializeWithProcessFilter(chrome.processId);
        processor.start();
        
        console.log('   åˆå§‹çŠ¶æ€: ä¸é™éŸ³ (5ç§’)');
        await sleep(5000);
        
        console.log('   åˆ‡æ¢: å¯ç”¨é™éŸ³ (5ç§’)');
        processor.setMuteOtherProcesses(true);
        await sleep(5000);
        
        console.log('   åˆ‡æ¢: ç¦ç”¨é™éŸ³ (5ç§’)');
        processor.setMuteOtherProcesses(false);
        await sleep(5000);
        
        processor.stop();
        console.log('âœ… æµ‹è¯•4å®Œæˆ');
        
        console.log('\n\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼');
        
        // éªŒè¯çŠ¶æ€
        console.log('\nğŸ“ˆ åŠŸèƒ½éªŒè¯:');
        console.log(`  é™éŸ³æ§åˆ¶çŠ¶æ€: ${processor.isMutingOtherProcesses()}`);
        
    } catch (error) {
        console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
    }
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// è¿è¡Œæµ‹è¯•
testMuteControl().catch(console.error);
```

**é¢„è®¡æ—¶é—´**: 1å°æ—¶

---

### Step 5: æ›´æ–°æ–‡æ¡£ âœ“

**æ–‡ä»¶**: `V2.1_RELEASE_NOTES.md`

å®Œæ•´çš„v2.1å‘å¸ƒè¯´æ˜ï¼ŒåŒ…æ‹¬ï¼š
- æ–°åŠŸèƒ½ä»‹ç»
- APIå˜æ›´è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹
- å‡çº§æŒ‡å—

**æ–‡ä»¶**: `README.md` (æ›´æ–°v2.1ç¤ºä¾‹)

**æ–‡ä»¶**: `V2_PROCESS_FILTER_GUIDE.md` (æ·»åŠ v2.1ç« èŠ‚)

**é¢„è®¡æ—¶é—´**: 1-2å°æ—¶

---

## ğŸ“Š å®æ–½æ—¶é—´è¡¨

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|---------|------|
| Step 1: AudioSessionManageræ‰©å±• | 2-3å°æ—¶ | â³ å¾…å¼€å§‹ |
| Step 2: AudioClienté›†æˆ | 2-3å°æ—¶ | â³ å¾…å¼€å§‹ |
| Step 3: JavaScriptç»‘å®š | 2å°æ—¶ | â³ å¾…å¼€å§‹ |
| Step 4: æµ‹è¯•ç”¨ä¾‹ | 1å°æ—¶ | â³ å¾…å¼€å§‹ |
| Step 5: æ–‡æ¡£æ›´æ–° | 1-2å°æ—¶ | â³ å¾…å¼€å§‹ |
| **æ€»è®¡** | **8-11å°æ—¶** | **1-2å¤©** |

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½æ€§æŒ‡æ ‡

- âœ… èƒ½å¤Ÿè‡ªåŠ¨é™éŸ³éç›®æ ‡è¿›ç¨‹
- âœ… ç™½åå•è¿›ç¨‹ä¸è¢«é™éŸ³
- âœ… é»‘åå•è¿›ç¨‹å¼ºåˆ¶é™éŸ³
- âœ… è¿è¡Œæ—¶å¯åŠ¨æ€åˆ‡æ¢
- âœ… åœæ­¢æ•è·æ—¶æ¢å¤åŸå§‹é™éŸ³çŠ¶æ€

### æ€§èƒ½æŒ‡æ ‡

- âœ… é™éŸ³æ“ä½œå»¶è¿Ÿ < 100ms
- âœ… ä¸å½±å“éŸ³é¢‘æ•è·æ€§èƒ½
- âœ… å†…å­˜å ç”¨å¢åŠ  < 1MB

### è´¨é‡æŒ‡æ ‡

- âœ… éŸ³é¢‘çº¯å‡€åº¦æå‡åˆ° 90%
- âœ… å¤šä»»åŠ¡åœºæ™¯å™ªéŸ³å‡å°‘ > 80%
- âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- âœ… å‘åå…¼å®¹v2.0 API

---

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### 1. çŠ¶æ€ç®¡ç†

```cpp
// ä¿å­˜åŸå§‹çŠ¶æ€ï¼Œç¡®ä¿æ¢å¤æ—¶ä¸å½±å“ç”¨æˆ·é…ç½®
originalMuteStates_[processId] = currentMuteState;

// åœæ­¢æ—¶æ¢å¤
for (auto& [pid, state] : originalMuteStates_) {
    SetProcessMute(pid, state);
}
```

### 2. å®æ—¶æ›´æ–°

```cpp
// åœ¨æ•è·å¾ªç¯ä¸­å‘¨æœŸæ€§æ£€æŸ¥æ–°ä¼šè¯
void AudioClient::CaptureLoop() {
    while (isCapturing_) {
        // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡æ–°ä¼šè¯
        if (++frameCount % sampleRate == 0) {
            ApplyMuteControl();  // é‡æ–°åº”ç”¨é™éŸ³è§„åˆ™
        }
        
        // æ•è·éŸ³é¢‘...
    }
}
```

### 3. é”™è¯¯å¤„ç†

```cpp
// å¤„ç†ä¼šè¯æ¶ˆå¤±çš„æƒ…å†µ
if (session->GetState() == AudioSessionStateExpired) {
    originalMuteStates_.erase(processId);
    continue;
}
```

---

## ğŸš€ å¼€å§‹å®æ–½

ç°åœ¨å¼€å§‹æŒ‰æ­¥éª¤å®æ–½v2.1åŠŸèƒ½ï¼š

**å½“å‰ä»»åŠ¡**: Step 1 - æ‰©å±• AudioSessionManager ç±»

**æ–‡ä»¶**: `src/wasapi/audio_session_manager.h`

å‡†å¤‡å¼€å§‹ç¼–ç ...
