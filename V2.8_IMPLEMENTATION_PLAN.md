# v2.8.0 Implementation Plan - AGC + EQ

## ğŸ“‹ ç‰ˆæœ¬æ¦‚è¿°

**ç‰ˆæœ¬å·**: v2.8.0  
**å‘å¸ƒæ—¥æœŸ**: TBD  
**ä¸»é¢˜**: Audio Quality Enhancement - AGC + EQ

**æ ¸å¿ƒç›®æ ‡**: å®ç°è‡ªåŠ¨å¢ç›Šæ§åˆ¶ (AGC) å’Œ 3-band å‡è¡¡å™¨ (EQ)ï¼Œè¿›ä¸€æ­¥æå‡éŸ³é¢‘è´¨é‡å’Œ ASR è¯†åˆ«ç¨³å®šæ€§

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªåŠ¨å¢ç›Šæ§åˆ¶ (AGC) - Automatic Gain Control â­â­ é«˜ä¼˜å…ˆçº§

**åŠŸèƒ½æè¿°**: 
- è‡ªåŠ¨å¹³è¡¡éŸ³é¢‘éŸ³é‡æ³¢åŠ¨
- å°†è¿‡ä½æˆ–è¿‡é«˜çš„éŸ³é‡å½’ä¸€åŒ–åˆ°ç›®æ ‡ç”µå¹³
- æå‡ ASR è¯†åˆ«ç¨³å®šæ€§

**æŠ€æœ¯æ–¹æ¡ˆ**:

#### 1.1 ç®—æ³•é€‰å‹
```cpp
// æ–¹æ¡ˆ A: ç®€å• RMS-based AGC
class SimpleAGC {
    float target_rms_;      // ç›®æ ‡ RMS ç”µå¹³ (-20dB)
    float max_gain_;        // æœ€å¤§å¢ç›Š (20dB)
    float min_gain_;        // æœ€å°å¢ç›Š (-10dB)
    float attack_time_;     // æ”»å‡»æ—¶é—´ (10ms)
    float release_time_;    // é‡Šæ”¾æ—¶é—´ (100ms)
    float current_gain_;    // å½“å‰å¢ç›Š
    
    void Process(float* samples, int count);
    float ComputeRMS(const float* samples, int count);
    float ComputeGain(float rms);
};

// æ–¹æ¡ˆ B: WebRTC AGC (æ›´å¤æ‚ä½†æ•ˆæœæ›´å¥½)
// ä½¿ç”¨ WebRTC çš„å¼€æº AGC å®ç°
// https://webrtc.googlesource.com/src/+/refs/heads/main/modules/audio_processing/agc/
```

#### 1.2 å‚æ•°è®¾è®¡
```javascript
capture.setAGCEnabled(true);
capture.setAGCOptions({
    targetLevel: -20,      // ç›®æ ‡ç”µå¹³ (dBFS)
    maxGain: 20,           // æœ€å¤§å¢ç›Š (dB)
    minGain: -10,          // æœ€å°å¢ç›Š (dB)
    attackTime: 10,        // æ”»å‡»æ—¶é—´ (ms)
    releaseTime: 100,      // é‡Šæ”¾æ—¶é—´ (ms)
    mode: 'adaptive'       // 'simple' | 'adaptive'
});

const stats = capture.getAGCStats();
// {
//     enabled: true,
//     currentGain: 5.2,    // dB
//     averageLevel: -18.5, // dBFS
//     clipping: false
// }
```

#### 1.3 å®ç°æ­¥éª¤
1. åˆ›å»º `src/napi/agc_processor.h` å’Œ `agc_processor.cpp`
2. å®ç° SimpleAGC ç®—æ³•ï¼ˆPhase 1ï¼‰
3. åœ¨ `AudioProcessor::OnAudioData()` ä¸­é›†æˆ
4. æ·»åŠ  TypeScript ç±»å‹å®šä¹‰
5. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
6. ä¼˜åŒ–ï¼šé›†æˆ WebRTC AGCï¼ˆPhase 2, Optionalï¼‰

---

### 2. 3-Band å‡è¡¡å™¨ (EQ) â­â­ é«˜ä¼˜å…ˆçº§

**åŠŸèƒ½æè¿°**:
- 3é¢‘æ®µå‡è¡¡å™¨ï¼šé«˜é¢‘/ä¸­é¢‘/ä½é¢‘
- å¢å¼ºäººå£°æ¸…æ™°åº¦
- å¯è°ƒèŠ‚å„é¢‘æ®µå¢ç›Š

**æŠ€æœ¯æ–¹æ¡ˆ**:

#### 2.1 æ»¤æ³¢å™¨è®¾è®¡
```cpp
// ä½¿ç”¨ Biquad IIR æ»¤æ³¢å™¨å®ç° 3-band EQ
class ThreeBandEQ {
    // Low Shelf: < 500 Hz
    BiquadFilter low_shelf_;
    
    // Parametric (Bell): 500-4000 Hz
    BiquadFilter mid_bell_;
    
    // High Shelf: > 4000 Hz
    BiquadFilter high_shelf_;
    
    void Process(float* samples, int count, int channels);
    void SetBandGain(Band band, float gain_db);
};

// Biquad æ»¤æ³¢å™¨
class BiquadFilter {
    double a0_, a1_, a2_;  // åˆ†å­ç³»æ•°
    double b0_, b1_, b2_;  // åˆ†æ¯ç³»æ•°
    double x1_, x2_;       // è¾“å…¥å†å²
    double y1_, y2_;       // è¾“å‡ºå†å²
    
    void DesignLowShelf(float freq, float Q, float gain, float sample_rate);
    void DesignPeaking(float freq, float Q, float gain, float sample_rate);
    void DesignHighShelf(float freq, float Q, float gain, float sample_rate);
    float ProcessSample(float input);
};
```

#### 2.2 é¢‘æ®µåˆ’åˆ†
```
Low:  20 Hz - 500 Hz   (ä½é¢‘ - ä½éŸ³ã€åŸºç¡€éŸ³)
Mid:  500 Hz - 4 kHz   (ä¸­é¢‘ - äººå£°æ ¸å¿ƒé¢‘æ®µ)
High: 4 kHz - 20 kHz   (é«˜é¢‘ - æ¸…æ™°åº¦ã€ç»†èŠ‚)
```

#### 2.3 API è®¾è®¡
```javascript
capture.setEQEnabled(true);
capture.setEQOptions({
    lowGain: 0,      // -12 to +12 dB
    midGain: 3,      // å¢å¼ºäººå£°
    highGain: 2,     // å¢å¼ºæ¸…æ™°åº¦
    lowFreq: 500,    // ä½/ä¸­åˆ†ç•Œç‚¹ (Hz)
    highFreq: 4000   // ä¸­/é«˜åˆ†ç•Œç‚¹ (Hz)
});

const eq = capture.getEQSettings();
// {
//     enabled: true,
//     lowGain: 0,
//     midGain: 3,
//     highGain: 2
// }
```

#### 2.4 å®ç°æ­¥éª¤
1. åˆ›å»º `src/napi/eq_processor.h` å’Œ `eq_processor.cpp`
2. å®ç° BiquadFilter åŸºç¡€ç±»
3. å®ç° ThreeBandEQ
4. åœ¨ `AudioProcessor::OnAudioData()` ä¸­é›†æˆ
5. æ·»åŠ  TypeScript ç±»å‹å®šä¹‰
6. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

---

### 3. N-API å¼‚å¸¸ä¿®å¤ â­ ä¸­ä¼˜å…ˆçº§

**é—®é¢˜**: ä¹‹å‰å·²åœ¨ v2.7.1 ä¿®å¤ï¼Œä½†éœ€è¦éªŒè¯ç¨³å®šæ€§

**ä»»åŠ¡**:
- è¿è¡Œé•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•ï¼ˆ1å°æ—¶+ï¼‰
- éªŒè¯å¤šå®ä¾‹åœºæ™¯
- ç¡®ä¿æ— å†…å­˜æ³„æ¼

---

### 4. GitHub Actions CI/CD â­ ä¸­ä¼˜å…ˆçº§

**åŠŸèƒ½æè¿°**: è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•

**ä»»åŠ¡**:
1. åˆ›å»º `.github/workflows/build.yml`
2. é…ç½®å¤š Node.js ç‰ˆæœ¬æµ‹è¯• (16, 18, 20, 22)
3. è‡ªåŠ¨è¿è¡Œæµ‹è¯•å¥—ä»¶
4. é¢„ç¼–è¯‘äºŒè¿›åˆ¶åŒ…æ„å»º
5. è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releases

---

## ğŸ“Š æ€§èƒ½ç›®æ ‡

### AGC æ€§èƒ½æŒ‡æ ‡
- âœ… å¤„ç†å»¶è¿Ÿ: < 5ms (ç›®æ ‡: < 2ms)
- âœ… CPU å ç”¨: < 0.5% é¢å¤–å¼€é”€
- âœ… éŸ³é‡æ³¢åŠ¨: Â±3dB â†’ Â±0.5dB
- âœ… æ— æ˜æ˜¾å¤±çœŸ

### EQ æ€§èƒ½æŒ‡æ ‡
- âœ… å¤„ç†å»¶è¿Ÿ: < 3ms (ç›®æ ‡: < 1ms)
- âœ… CPU å ç”¨: < 0.3% é¢å¤–å¼€é”€
- âœ… é¢‘ç‡å“åº”: ç²¾ç¡®åˆ° Â±0.5dB
- âœ… æ— ç›¸ä½å¤±çœŸ

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```javascript
describe('AGC', () => {
    test('should normalize volume', () => {
        // æµ‹è¯•éŸ³é‡å½’ä¸€åŒ–
    });
    
    test('should handle peak limiting', () => {
        // æµ‹è¯•å³°å€¼é™åˆ¶
    });
    
    test('should have low latency', () => {
        // æµ‹è¯•å»¶è¿Ÿ < 5ms
    });
});

describe('EQ', () => {
    test('should boost/cut frequencies', () => {
        // æµ‹è¯•é¢‘æ®µå¢ç›Š
    });
    
    test('should maintain phase linearity', () => {
        // æµ‹è¯•ç›¸ä½çº¿æ€§åº¦
    });
});
```

### é›†æˆæµ‹è¯•
```javascript
test('AGC + RNNoise integration', async () => {
    const capture = new AudioCapture({
        processId: 0,
        useExternalBuffer: true
    });
    
    capture.setDenoiseEnabled(true);
    capture.setAGCEnabled(true);
    capture.setEQEnabled(true);
    
    // æµ‹è¯•æ‰€æœ‰ç‰¹æ€§åŒæ—¶å¯ç”¨
});
```

### æ€§èƒ½æµ‹è¯•
- CPU ä½¿ç”¨ç‡æµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰
- å»¶è¿Ÿæµ‹è¯•ï¼ˆ1000æ¬¡é‡‡æ ·ï¼‰
- éŸ³è´¨æµ‹è¯•ï¼ˆä¸»è§‚è¯„ä»· + å®¢è§‚æŒ‡æ ‡ï¼‰

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/napi/
  â”œâ”€â”€ agc_processor.h           // AGC å¤„ç†å™¨å¤´æ–‡ä»¶
  â”œâ”€â”€ agc_processor.cpp         // AGC å®ç°
  â”œâ”€â”€ eq_processor.h            // EQ å¤„ç†å™¨å¤´æ–‡ä»¶
  â”œâ”€â”€ eq_processor.cpp          // EQ å®ç°
  â”œâ”€â”€ biquad_filter.h           // Biquad æ»¤æ³¢å™¨
  â”œâ”€â”€ biquad_filter.cpp         // Biquad å®ç°
  â””â”€â”€ audio_processor.cpp       // é›†æˆ AGC + EQ

examples/
  â”œâ”€â”€ agc-example.js            // AGC ç¤ºä¾‹
  â”œâ”€â”€ eq-example.js             // EQ ç¤ºä¾‹
  â””â”€â”€ full-pipeline.js          // AGC + EQ + RNNoise å®Œæ•´ç®¡é“

test/
  â”œâ”€â”€ agc.test.js               // AGC æµ‹è¯•
  â”œâ”€â”€ eq.test.js                // EQ æµ‹è¯•
  â””â”€â”€ audio-pipeline.test.js    // å®Œæ•´ç®¡é“æµ‹è¯•

docs/
  â”œâ”€â”€ V2.8_IMPLEMENTATION_PLAN.md     // æœ¬æ–‡æ¡£
  â”œâ”€â”€ V2.8_AGC_GUIDE.md              // AGC ä½¿ç”¨æŒ‡å—
  â””â”€â”€ V2.8_EQ_GUIDE.md               // EQ ä½¿ç”¨æŒ‡å—
```

---

## ğŸ“… å¼€å‘è®¡åˆ’

### Week 1-2: AGC å®ç°
- [ ] Day 1-2: SimpleAGC ç®—æ³•å®ç°
- [ ] Day 3-4: é›†æˆåˆ° AudioProcessor
- [ ] Day 5-6: æµ‹è¯• + ä¼˜åŒ–
- [ ] Day 7: æ–‡æ¡£ç¼–å†™

### Week 3: EQ å®ç°
- [ ] Day 1-2: BiquadFilter å®ç°
- [ ] Day 3-4: ThreeBandEQ å®ç° + é›†æˆ
- [ ] Day 5-6: æµ‹è¯• + ä¼˜åŒ–
- [ ] Day 7: æ–‡æ¡£ç¼–å†™

### Week 4: CI/CD + å‘å¸ƒ
- [ ] Day 1-2: GitHub Actions é…ç½®
- [ ] Day 3-4: å®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] Day 5: æ€§èƒ½éªŒè¯
- [ ] Day 6: æ–‡æ¡£å®Œå–„
- [ ] Day 7: v2.8.0 å‘å¸ƒ

---

## ğŸ”— å‚è€ƒèµ„æ–™

### AGC
- [WebRTC AGC Implementation](https://webrtc.googlesource.com/src/+/refs/heads/main/modules/audio_processing/agc/)
- [Digital Audio Processing - AGC Algorithms](https://www.dsprelated.com/freebooks/pasp/Automatic_Gain_Control_AGC.html)

### EQ / Biquad Filters
- [Audio EQ Cookbook (Robert Bristow-Johnson)](https://webaudio.github.io/Audio-EQ-Cookbook/audio-eq-cookbook.html)
- [Biquad Filter Design](https://www.dsprelated.com/freebooks/filters/Biquad_Section.html)
- [Three Band EQ Implementation](https://www.musicdsp.org/en/latest/Filters/236-3-band-equaliser.html)

### DSP Libraries
- [SpeexDSP](https://gitlab.xiph.org/xiph/speexdsp) - å¯èƒ½çš„å‚è€ƒå®ç°
- [PortAudio DSP Examples](http://www.portaudio.com/) - éŸ³é¢‘å¤„ç†ç¤ºä¾‹

---

## âœ… Definition of Done

- [ ] AGC å’Œ EQ åŠŸèƒ½å®Œæ•´å®ç°
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ100% è¦†ç›–ç‡ï¼‰
- [ ] æ€§èƒ½ç›®æ ‡è¾¾æˆï¼ˆå»¶è¿Ÿ < 5ms, CPU < 0.5%ï¼‰
- [ ] æ–‡æ¡£å®Œå–„ï¼ˆAPI æ–‡æ¡£ + ç”¨æˆ·æŒ‡å—ï¼‰
- [ ] GitHub Actions CI/CD é…ç½®å®Œæˆ
- [ ] v2.8.0 å‘å¸ƒåˆ° GitHub Releases
- [ ] README å’Œ CHANGELOG æ›´æ–°

---

**ä¼˜å…ˆçº§**:
- P0 (å¿…é¡»): AGC + EQ æ ¸å¿ƒåŠŸèƒ½
- P1 (é‡è¦): æ€§èƒ½ä¼˜åŒ– + æµ‹è¯•
- P2 (å¯é€‰): CI/CD + WebRTC AGCé›†æˆ

**é¢„è®¡å·¥ä½œé‡**: 3-4 å‘¨

**æŠ€æœ¯éš¾ç‚¹**:
1. Biquad æ»¤æ³¢å™¨ç³»æ•°è®¡ç®—ç²¾åº¦
2. AGC æ”»å‡»/é‡Šæ”¾æ—¶é—´å¹³æ»‘æ€§
3. å¤šä¸ªå¤„ç†å™¨ä¸²è”çš„æ€§èƒ½ä¼˜åŒ–
4. ç›¸ä½çº¿æ€§åº¦ä¿æŒ
