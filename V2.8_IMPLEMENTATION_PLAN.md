# v2.8.0 Implementation Plan - AGC + EQ

## 📋 版本概述

**版本号**: v2.8.0  
**发布日期**: TBD  
**主题**: Audio Quality Enhancement - AGC + EQ

**核心目标**: 实现自动增益控制 (AGC) 和 3-band 均衡器 (EQ)，进一步提升音频质量和 ASR 识别稳定性

---

## 🎯 核心特性

### 1. 自动增益控制 (AGC) - Automatic Gain Control ⭐⭐ 高优先级

**功能描述**: 
- 自动平衡音频音量波动
- 将过低或过高的音量归一化到目标电平
- 提升 ASR 识别稳定性

**技术方案**:

#### 1.1 算法选型
```cpp
// 方案 A: 简单 RMS-based AGC
class SimpleAGC {
    float target_rms_;      // 目标 RMS 电平 (-20dB)
    float max_gain_;        // 最大增益 (20dB)
    float min_gain_;        // 最小增益 (-10dB)
    float attack_time_;     // 攻击时间 (10ms)
    float release_time_;    // 释放时间 (100ms)
    float current_gain_;    // 当前增益
    
    void Process(float* samples, int count);
    float ComputeRMS(const float* samples, int count);
    float ComputeGain(float rms);
};

// 方案 B: WebRTC AGC (更复杂但效果更好)
// 使用 WebRTC 的开源 AGC 实现
// https://webrtc.googlesource.com/src/+/refs/heads/main/modules/audio_processing/agc/
```

#### 1.2 参数设计
```javascript
capture.setAGCEnabled(true);
capture.setAGCOptions({
    targetLevel: -20,      // 目标电平 (dBFS)
    maxGain: 20,           // 最大增益 (dB)
    minGain: -10,          // 最小增益 (dB)
    attackTime: 10,        // 攻击时间 (ms)
    releaseTime: 100,      // 释放时间 (ms)
    mode: 'adaptive'       // 'simple' | 'adaptive'
});

const stats = capture.getAGCStats();
// {
//     enabled: true,
//     currentGain: 5.2,    // dB
//     averageLevel: -18.5, // dBFS
//     clipping: false
// }
```

#### 1.3 实现步骤
1. 创建 `src/napi/agc_processor.h` 和 `agc_processor.cpp`
2. 实现 SimpleAGC 算法（Phase 1）
3. 在 `AudioProcessor::OnAudioData()` 中集成
4. 添加 TypeScript 类型定义
5. 编写测试用例
6. 优化：集成 WebRTC AGC（Phase 2, Optional）

---

### 2. 3-Band 均衡器 (EQ) ⭐⭐ 高优先级

**功能描述**:
- 3频段均衡器：高频/中频/低频
- 增强人声清晰度
- 可调节各频段增益

**技术方案**:

#### 2.1 滤波器设计
```cpp
// 使用 Biquad IIR 滤波器实现 3-band EQ
class ThreeBandEQ {
    // Low Shelf: < 500 Hz
    BiquadFilter low_shelf_;
    
    // Parametric (Bell): 500-4000 Hz
    BiquadFilter mid_bell_;
    
    // High Shelf: > 4000 Hz
    BiquadFilter high_shelf_;
    
    void Process(float* samples, int count, int channels);
    void SetBandGain(Band band, float gain_db);
};

// Biquad 滤波器
class BiquadFilter {
    double a0_, a1_, a2_;  // 分子系数
    double b0_, b1_, b2_;  // 分母系数
    double x1_, x2_;       // 输入历史
    double y1_, y2_;       // 输出历史
    
    void DesignLowShelf(float freq, float Q, float gain, float sample_rate);
    void DesignPeaking(float freq, float Q, float gain, float sample_rate);
    void DesignHighShelf(float freq, float Q, float gain, float sample_rate);
    float ProcessSample(float input);
};
```

#### 2.2 频段划分
```
Low:  20 Hz - 500 Hz   (低频 - 低音、基础音)
Mid:  500 Hz - 4 kHz   (中频 - 人声核心频段)
High: 4 kHz - 20 kHz   (高频 - 清晰度、细节)
```

#### 2.3 API 设计
```javascript
capture.setEQEnabled(true);
capture.setEQOptions({
    lowGain: 0,      // -12 to +12 dB
    midGain: 3,      // 增强人声
    highGain: 2,     // 增强清晰度
    lowFreq: 500,    // 低/中分界点 (Hz)
    highFreq: 4000   // 中/高分界点 (Hz)
});

const eq = capture.getEQSettings();
// {
//     enabled: true,
//     lowGain: 0,
//     midGain: 3,
//     highGain: 2
// }
```

#### 2.4 实现步骤
1. 创建 `src/napi/eq_processor.h` 和 `eq_processor.cpp`
2. 实现 BiquadFilter 基础类
3. 实现 ThreeBandEQ
4. 在 `AudioProcessor::OnAudioData()` 中集成
5. 添加 TypeScript 类型定义
6. 编写测试用例

---

### 3. N-API 异常修复 ⭐ 中优先级

**问题**: 之前已在 v2.7.1 修复，但需要验证稳定性

**任务**:
- 运行长时间稳定性测试（1小时+）
- 验证多实例场景
- 确保无内存泄漏

---

### 4. GitHub Actions CI/CD ⭐ 中优先级

**功能描述**: 自动化构建和测试

**任务**:
1. 创建 `.github/workflows/build.yml`
2. 配置多 Node.js 版本测试 (16, 18, 20, 22)
3. 自动运行测试套件
4. 预编译二进制包构建
5. 自动发布到 GitHub Releases

---

## 📊 性能目标

### AGC 性能指标
- ✅ 处理延迟: < 5ms (目标: < 2ms)
- ✅ CPU 占用: < 0.5% 额外开销
- ✅ 音量波动: ±3dB → ±0.5dB
- ✅ 无明显失真

### EQ 性能指标
- ✅ 处理延迟: < 3ms (目标: < 1ms)
- ✅ CPU 占用: < 0.3% 额外开销
- ✅ 频率响应: 精确到 ±0.5dB
- ✅ 无相位失真

---

## 🧪 测试策略

### 单元测试
```javascript
describe('AGC', () => {
    test('should normalize volume', () => {
        // 测试音量归一化
    });
    
    test('should handle peak limiting', () => {
        // 测试峰值限制
    });
    
    test('should have low latency', () => {
        // 测试延迟 < 5ms
    });
});

describe('EQ', () => {
    test('should boost/cut frequencies', () => {
        // 测试频段增益
    });
    
    test('should maintain phase linearity', () => {
        // 测试相位线性度
    });
});
```

### 集成测试
```javascript
test('AGC + RNNoise integration', async () => {
    const capture = new AudioCapture({
        processId: 0,
        useExternalBuffer: true
    });
    
    capture.setDenoiseEnabled(true);
    capture.setAGCEnabled(true);
    capture.setEQEnabled(true);
    
    // 测试所有特性同时启用
});
```

### 性能测试
- CPU 使用率测试（1小时）
- 延迟测试（1000次采样）
- 音质测试（主观评价 + 客观指标）

---

## 📁 文件结构

```
src/napi/
  ├── agc_processor.h           // AGC 处理器头文件
  ├── agc_processor.cpp         // AGC 实现
  ├── eq_processor.h            // EQ 处理器头文件
  ├── eq_processor.cpp          // EQ 实现
  ├── biquad_filter.h           // Biquad 滤波器
  ├── biquad_filter.cpp         // Biquad 实现
  └── audio_processor.cpp       // 集成 AGC + EQ

examples/
  ├── agc-example.js            // AGC 示例
  ├── eq-example.js             // EQ 示例
  └── full-pipeline.js          // AGC + EQ + RNNoise 完整管道

test/
  ├── agc.test.js               // AGC 测试
  ├── eq.test.js                // EQ 测试
  └── audio-pipeline.test.js    // 完整管道测试

docs/
  ├── V2.8_IMPLEMENTATION_PLAN.md     // 本文档
  ├── V2.8_AGC_GUIDE.md              // AGC 使用指南
  └── V2.8_EQ_GUIDE.md               // EQ 使用指南
```

---

## 📅 开发计划

### Week 1-2: AGC 实现
- [ ] Day 1-2: SimpleAGC 算法实现
- [ ] Day 3-4: 集成到 AudioProcessor
- [ ] Day 5-6: 测试 + 优化
- [ ] Day 7: 文档编写

### Week 3: EQ 实现
- [ ] Day 1-2: BiquadFilter 实现
- [ ] Day 3-4: ThreeBandEQ 实现 + 集成
- [ ] Day 5-6: 测试 + 优化
- [ ] Day 7: 文档编写

### Week 4: CI/CD + 发布
- [ ] Day 1-2: GitHub Actions 配置
- [ ] Day 3-4: 完整测试套件
- [ ] Day 5: 性能验证
- [ ] Day 6: 文档完善
- [ ] Day 7: v2.8.0 发布

---

## 🔗 参考资料

### AGC
- [WebRTC AGC Implementation](https://webrtc.googlesource.com/src/+/refs/heads/main/modules/audio_processing/agc/)
- [Digital Audio Processing - AGC Algorithms](https://www.dsprelated.com/freebooks/pasp/Automatic_Gain_Control_AGC.html)

### EQ / Biquad Filters
- [Audio EQ Cookbook (Robert Bristow-Johnson)](https://webaudio.github.io/Audio-EQ-Cookbook/audio-eq-cookbook.html)
- [Biquad Filter Design](https://www.dsprelated.com/freebooks/filters/Biquad_Section.html)
- [Three Band EQ Implementation](https://www.musicdsp.org/en/latest/Filters/236-3-band-equaliser.html)

### DSP Libraries
- [SpeexDSP](https://gitlab.xiph.org/xiph/speexdsp) - 可能的参考实现
- [PortAudio DSP Examples](http://www.portaudio.com/) - 音频处理示例

---

## ✅ Definition of Done

- [ ] AGC 和 EQ 功能完整实现
- [ ] 所有单元测试通过（100% 覆盖率）
- [ ] 性能目标达成（延迟 < 5ms, CPU < 0.5%）
- [ ] 文档完善（API 文档 + 用户指南）
- [ ] GitHub Actions CI/CD 配置完成
- [ ] v2.8.0 发布到 GitHub Releases
- [ ] README 和 CHANGELOG 更新

---

**优先级**:
- P0 (必须): AGC + EQ 核心功能
- P1 (重要): 性能优化 + 测试
- P2 (可选): CI/CD + WebRTC AGC集成

**预计工作量**: 3-4 周

**技术难点**:
1. Biquad 滤波器系数计算精度
2. AGC 攻击/释放时间平滑性
3. 多个处理器串联的性能优化
4. 相位线性度保持
