# 📋 v2.7 开发规划 - 底层音频库优化

**文档版本**: v1.0  
**创建日期**: 2025年10月15日  
**基于**: v2.6.0 Zero-Copy 发布成果  
**定位**: 底层音频捕获库，专注核心功能

---

## 🎯 v2.6.0 成果回顾

### 核心突破

| 指标 | v2.5.0 | v2.6.0 | 改进 |
|------|--------|--------|------|
| 堆增长率 | +8.09 KB/s | **-4.25 KB/s** | **151.3%** ⚡ |
| 5分钟堆变化 | +2.4 MB | **-0.08 MB** | **负增长** 💚 |
| 1小时堆变化 | 未测试 | **-0.10 MB** | **负增长** 💚 |
| 稳定性 | 111 包崩溃 | **360,000+ 包** | **3200x** ✅ |
| Buffer Pool | 无 | 100 buffers | **新增** 📊 |
| 监控 API | 无 | getPoolStats() | **新增** 🔍 |

### 技术价值

1. ✅ **Zero-Copy 架构** - N-API external buffers，消除内存拷贝
2. ✅ **负堆增长** - 长时间运行内存实际减少
3. ✅ **生产验证** - 1小时测试，360K+ 包，0错误
4. ✅ **完整监控** - Pool 统计 API，实时性能数据
5. ✅ **向后兼容** - opt-in 设计，零风险升级

---

## 🔍 当前架构分析

### 优势

1. ✅ **性能优秀** - Kaiser Sinc 重采样，42% 性能提升
2. ✅ **内存高效** - Zero-copy + negative growth
3. ✅ **功能完整** - 捕获、转换、ASR 预设、设备管理
4. ✅ **稳定可靠** - 长期测试验证

### 可优化点

1. ⚠️ **Zero-Copy opt-in** - 当前需手动启用，应考虑默认
2. ⚠️ **Buffer Pool 固定** - 100 buffers 固定，hit rate 低（0.33%）
3. ⚠️ **发布流程手动** - 无 CI/CD，依赖手动构建
4. ⚠️ **采样率有限** - 仅 16kHz, 48kHz，缺少其他常用采样率

---

## 🚀 v2.7 开发规划

### 优先级分类

| 优先级 | 说明 | 开发周期 |
|--------|------|---------|
| P0 | 核心功能，必须实现 | 立即 |
| P1 | 重要优化，应该实现 | 1-2 周 |
| P2 | 增强功能，可以实现 | 1-2 月 |

---

### P0 - 核心功能（v2.7.0）

#### 1. 自适应 Buffer Pool ⭐⭐⭐⭐⭐

**优先级调整**: 从 P0 #2 → P0 #1（基于技术风险评估）

**现状问题**：
- 固定 100 buffers
- Hit rate 仅 0.33%（1小时测试）
- 原因：V8 GC 延迟导致 buffer 回收慢

**优化目标**：
- 根据实际负载动态调整池大小
- 平衡内存占用与性能
- 提高 hit rate 到 2-5%

**实现方案**：

```typescript
// 新增配置
interface AudioCaptureOptions {
  bufferPoolSize?: number | 'auto';  // 默认 'auto'
  bufferPoolStrategy?: 'fixed' | 'adaptive';  // 默认 'adaptive'
  bufferPoolMin?: number;  // 最小池大小，默认 50
  bufferPoolMax?: number;  // 最大池大小，默认 200
}
```

**自适应策略**：
```
初始池大小: 50 buffers
评估周期: 每 10 秒

评估逻辑:
- Hit rate < 1% 且池大小 < max: 增加 25 buffers
- Hit rate > 5% 且池大小 > min: 减少 25 buffers
- Hit rate 1-5%: 保持当前大小
```

**预期效果**：
- Hit rate: 0.33% → 2-5%
- 内存占用: 根据负载优化（50-200 buffers）
- 性能影响: 无（动态分配也使用 zero-copy）

**开发周期**：2 周（含测试）

---

#### 2. 音频降噪处理（RNNoise）⭐⭐⭐⭐⭐

**优先级提升**: 从 P2 → P0（用户需求）

**现状问题**：
- 系统音频捕获包含背景噪音
- 语音识别准确率受噪音影响
- ASR 场景需要更清晰的音频

**优化目标**：
- 集成 RNNoise 深度学习降噪算法
- 实时处理，低延迟（< 10ms）
- 简单易用的 API

**实现方案**：

```typescript
// 新增配置
interface AudioCaptureOptions {
  effects?: {
    denoise?: boolean;        // 启用降噪，默认 false
    denoiseModel?: string;    // 模型路径（可选）
  };
}
```

**使用示例**：
```javascript
const capture = new AudioCapture({
  processId: 0,
  useExternalBuffer: true,  // 推荐使用 zero-copy
  effects: {
    denoise: true  // 一行启用降噪！
  }
});

capture.on('data', (event) => {
  // event.buffer 已经过降噪处理
  // 直接发送到 ASR API
});
```

**技术方案**：
- **算法**: RNNoise（Mozilla 开源）
- **集成方式**: 编译为 C++ 静态库，集成到 N-API addon
- **处理流程**: WASAPI → Zero-Copy → RNNoise → JavaScript
- **帧大小**: 480 samples (10ms @ 48kHz)

**预期效果**：
- 噪音抑制: 15-20 dB
- CPU 开销: +3-5%
- 延迟增加: < 10ms
- ASR 准确率提升: 10-30%

**依赖项**：
```bash
# 需要 RNNoise 库
git submodule add https://github.com/xiph/rnnoise.git deps/rnnoise
```

**开发周期**：3 周
- 第 1 周: RNNoise 集成和编译
- 第 2 周: N-API 绑定和测试
- 第 3 周: 文档和示例

---

### P1 - 重要优化（v2.7.0 或 v2.7.1）

#### 3. 自动增益控制（AGC）⭐⭐⭐⭐

**目标**：音量归一化，保持稳定输出

**实现方案**：
```typescript
interface AudioCaptureOptions {
  effects?: {
    agc?: boolean;           // 启用 AGC
    targetLevel?: number;    // 目标音量 (0-1)，默认 0.5
  };
}
```

**算法**：
- 实时 RMS 计算
- 自适应增益调整
- 防削波保护

**开发周期**：1 周

---

#### 4. 音频均衡器（EQ）⭐⭐⭐

**目标**：音质优化，频率调整

**实现方案**：
```typescript
interface AudioCaptureOptions {
  effects?: {
    eq?: {
      low: number;      // 低频增益 (-12 to +12 dB)
      mid: number;      // 中频增益
      high: number;     // 高频增益
    };
  };
}
```

**算法**：
- 3 频段参数均衡器
- Biquad IIR 滤波器
- 实时处理

**开发周期**：1.5 周

---

#### 5. GitHub Actions CI/CD ⭐⭐⭐⭐

**目标**：
- 自动化测试（每次 push/PR）
- 多版本构建（Node.js 16/18/20/22）
- 自动化发布（tag 触发）

**工作流设计**：

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test:
    strategy:
      matrix:
        node: [16, 18, 20, 22]
        os: [windows-2019, windows-2022]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
      - run: npm install
      - run: npm run build
      - run: npm test
```

**收益**：
- 自动发现构建问题
- 确保多版本兼容性
- 提高代码质量

**开发周期**：1 周

---

#### 4. 预构建二进制优化 ⭐⭐⭐

**现状**：
- 用户需要本地编译（需要 VS + Windows SDK）
- 安装门槛高

**优化方案**：
```json
// package.json
{
  "binary": {
    "module_name": "audio_addon",
    "module_path": "./prebuilds/{platform}-{arch}/",
    "host": "https://github.com/wujelly701/node-windows-audio-capture/releases/"
  }
}
```

**支持矩阵**：
```
Platform: win32
Arch: x64, ia32, arm64
Node.js: 16, 18, 20, 22
Node-API: 8, 9
```

**开发周期**：2 周

---

#### 5. 更多采样率支持 ⭐⭐⭐

**现状**：仅支持 16kHz, 48kHz

**新增采样率**：
- 8kHz - 电话语音质量
- 24kHz - 高品质语音
- 32kHz - 广播质量
- 44.1kHz - CD 质量

**实现**：
- 扩展 Kaiser Sinc 重采样器
- 预计算新的系数表
- 单元测试验证

**开发周期**：1 周

---

### P2 - 增强功能（v2.8+）

#### 6. 音频效果处理 ⭐⭐⭐

**功能列表**：
1. **降噪**（RNNoise 集成）
2. **自动增益控制**（AGC）
3. **音频均衡器**（EQ）
4. **语音活动检测**（VAD）

**API 设计**：
```typescript
interface AudioCaptureOptions {
  effects?: {
    denoise?: boolean;  // 降噪
    agc?: boolean;      // 自动增益
    eq?: EQConfig;      // 均衡器
    vad?: VADConfig;    // 语音活动检测
  };
}
```

**开发周期**：2-3 个月（分多个版本实现）

---

#### 8. 流式重采样 API ⭐⭐

**现状**：需要完整 buffer 才能重采样

**优化**：支持流式处理
```typescript
const resampler = new StreamResampler({
  inputRate: 48000,
  outputRate: 16000
});

capture.on('data', (chunk) => {
  const resampled = resampler.process(chunk);
  // 实时输出
});
```

**开发周期**：2 周

---

#### 9. 跨平台支持 ⭐⭐⭐⭐⭐

**v3.0 目标**：
- macOS 支持（Core Audio）
- Linux 支持（PulseAudio/PipeWire）
- 统一 API 设计

**开发周期**：3-6 个月

---

## 📅 开发时间线

### v2.7.0 (2025年12月) 🎯 调整后

```
2025-10 月下旬 - 开发启动 ✅
2025-11 月上旬 - P0 特性开发
  ├─ 自适应 Buffer Pool (2周)
  └─ 音频降噪 RNNoise (3周，并行)
2025-11 月下旬 - P1 特性开发（可选）
  ├─ AGC 自动增益 (1周)
  └─ EQ 均衡器 (1.5周)
2025-11 月底 - v2.7.0-alpha 发布
2025-12 月初 - 充分测试
  ├─ 单元测试（Pool + 降噪）
  ├─ 5分钟稳定性测试
  ├─ 音频质量对比测试
  └─ ASR 准确率验证
2025-12 月中 - v2.7.0 正式发布 🎉
```

### v2.8.0 (2026年2月) - Zero-Copy 默认启用

```
2026-01 月初 - 开发启动
2026-01 月中 - Zero-Copy 默认启用
  ├─ 基于 v2.7 的自适应 Pool
  ├─ 解决 N-API 异常问题
  └─ 多实例场景测试
2026-01 月底 - v2.8.0-alpha 发布
2026-02 月初 - 充分测试
2026-02 月中 - v2.8.0 正式发布
```

### v2.8.1 (2026年3月) - 生态优化

```
2026-02 月底 - 开发启动
2026-03 月初 - P1 特性完成
  ├─ GitHub Actions CI/CD
  ├─ 预构建二进制
  └─ 更多采样率
2026-03 月中 - v2.8.1-beta 发布
2026-03 月底 - v2.8.1 正式发布
```

### v2.8+ (2026年Q2+)
- 音频效果处理
- 流式重采样
- 更多高级特性

### v3.0 (2026年下半年)
- 跨平台支持

---

## 🎯 核心原则

### 1. 保持库的职责单一

**专注于**：
- ✅ 高性能音频捕获
- ✅ 基础格式转换
- ✅ 稳定可靠的 API

**不包括**：
- ❌ ASR/STT 集成（应用层负责）
- ❌ 翻译功能（应用层负责）
- ❌ UI 组件（应用层负责）
- ❌ 业务逻辑（应用层负责）

### 2. API 设计原则

- 简单易用（最小化配置）
- 向后兼容（渐进式增强）
- 性能优先（零拷贝、低延迟）
- 文档完整（示例丰富）

### 3. 质量标准

- 100% 向后兼容
- 完整测试覆盖
- 详细文档说明
- 性能基准测试

---

## 📊 成功标准

### v2.7.0 成功标准（调整后）

1. ✅ 自适应 Buffer Pool hit rate 提升至 2-5%
2. ✅ 音频降噪集成成功（RNNoise）
3. ✅ 噪音抑制达到 15-20 dB
4. ✅ ASR 准确率提升 10-30%（实测）
5. ✅ 100% 向后兼容（opt-in 设计）
6. ✅ 完整测试覆盖（单元 + 集成 + 音频质量）
7. ✅ 详细文档和示例代码

### v2.8.0 成功标准（Zero-Copy 默认）

1. ✅ Zero-Copy 默认启用，无性能回退
2. ✅ 解决 N-API 异常问题
3. ✅ 多实例场景稳定
4. ✅ 提供回退方案
5. ✅ 详细迁移指南

### v2.8.1 成功标准（生态优化）

1. ✅ CI/CD 自动化测试通过率 100%
2. ✅ 预构建二进制支持 4+ Node.js 版本
3. ✅ 新增 4 种采样率支持
4. ✅ 用户安装无需编译环境

---

## 💡 给库维护者的建议

### 开发优先级（调整后）

**立即开始（P0 - v2.7.0）**：
1. ✅ 自适应 Buffer Pool（优化内存，已开始）
2. 🎵 音频降噪 RNNoise（用户需求，高优先级）
3. 🔊 AGC + EQ（可选，如时间允许）

**短期规划（P1 - v2.8.0）**：
4. Zero-Copy 默认启用（基于 v2.7 稳定性）
5. 解决 N-API 异常问题

**中期规划（P1 - v2.8.1）**：
6. CI/CD（提高开发效率）
7. 预构建二进制（降低用户门槛）
8. 更多采样率（扩展使用场景）

**长期规划（P2 - v2.9+）**：
9. VAD 语音活动检测
10. 流式重采样
11. 跨平台支持（v3.0）

### 技术债务管理

### v2.7 需要解决（调整后）**：
- [ ] Buffer Pool hit rate 低（0.33% → 2-5%） ⭐ P0
- [ ] 音频降噪集成（RNNoise） ⭐ P0
- [ ] AGC + EQ 实现（可选） ⭐ P1

**v2.8 需要解决**：
- [ ] Zero-Copy 默认启用（基于 v2.7 稳定性）
- [ ] N-API 异常问题修复
- [ ] 手动发布流程（改为自动化）
- [ ] 编译依赖（提供预构建二进制）

**v2.9+ 考虑**：
- [ ] VAD 语音活动检测
- [ ] 更灵活的 Buffer 管理策略
- [ ] 跨平台架构设计

---

## 🔥 风险评估

### v2.7.0 风险（调整后）

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 自适应 Pool 引入性能问题 | 中 | 低 | 充分测试 + 可配置开关 |
| RNNoise 集成编译问题 | 中 | 中 | 提前验证编译环境 + 详细文档 |
| 降噪 CPU 开销过高 | 中 | 低 | 性能测试 + opt-in 设计 |
| 音频质量下降 | 高 | 低 | A/B 测试 + 可配置强度 |

### 整体风险：**低-中** �

v2.7 主要是新功能添加（opt-in 设计），不影响现有功能。RNNoise 是成熟算法，风险可控。

---

## 📝 总结

### v2.6.0 是里程碑 ✅
- Zero-Copy 架构验证成功
- 负堆增长证明内存优秀
- 生产级稳定性（360K+ 包）

### v2.7.0 聚焦音频质量 🎯 调整后
- **音频降噪 RNNoise**（显著提升语音清晰度） ⭐ NEW
- **自适应 Buffer Pool**（内存优化）
- **AGC + EQ**（音质优化，可选）
- **保持 opt-in 设计**（向后兼容，零风险）

### v2.8.0 聚焦性能 ⚡
- Zero-Copy 默认启用（性能开箱即用）
- N-API 异常修复（多实例稳定）
- CI/CD + 预构建（生态优化）

### 保持库的定位 🎯
- ✅ 底层音频捕获库
- ✅ 高性能、低延迟
- ✅ 基础音频处理（降噪、AGC、EQ）
- ✅ 简单易用、稳定可靠
- ❌ 不做业务层功能（ASR集成、UI等）

---

**文档作者**: GitHub Copilot  
**审核状态**: 待审核  
**更新频率**: 每个版本发布后更新  
**适用范围**: node-windows-audio-capture 底层库开发
