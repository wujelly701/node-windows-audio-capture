# v2.3.0 Release Notes - Device Selection Feature

**Release Date**: 2025-01-XX (In Development)  
**Status**: ğŸš§ Feature Branch - `feature/device-selection`  
**Backward Compatible**: âœ… Yes (100%)

---

## ğŸ¯ Release Overview

v2.3.0 introduces **audio device selection**, allowing you to capture audio from specific audio output devices instead of only the system default. This enables multi-device audio monitoring, user device preferences, and hardware-specific audio capture scenarios.

### Key Highlights

- ğŸ§ **Device Enumeration**: List all available audio output devices
- ğŸ›ï¸ **Device Selection**: Capture from specific devices by ID
- ğŸ”€ **Multi-Device Support**: Capture multiple devices simultaneously
- ğŸ”— **Filter Combination**: Device selection + process filtering
- âœ… **Backward Compatible**: No breaking changes, deviceId is optional

---

## ğŸ†• What's New

### 1. Audio Device Enumeration

Get a list of all available audio output devices on the system:

```javascript
const AudioCapture = require('node-windows-audio-capture');

const devices = await AudioCapture.getAudioDevices();

console.log('Available devices:', devices);
// Output:
// [
//   {
//     id: '{0.0.0.00000000}.{442acc96-3e92-4570-9165-b858c1635ffe}',
//     name: 'Realtek High Definition Audio',
//     description: 'Speakers (Realtek High Definition Audio)',
//     isDefault: false,
//     isActive: true
//   },
//   {
//     id: '{0.0.0.00000000}.{e11253b2-d468-45ee-ae90-2ee64b1f3f7c}',
//     name: 'NVIDIA High Definition Audio',
//     description: 'NVIDIA G7c II (NVIDIA High Definition Audio)',
//     isDefault: true,
//     isActive: true
//   }
// ]
```

### 2. Device-Specific Capture

Capture audio from a specific device:

```javascript
const devices = await AudioCapture.getAudioDevices();

// Select a device
const realtekDevice = devices.find(d => d.name.includes('Realtek'));

// Create capture with specific device
const capture = new AudioCapture({
  deviceId: realtekDevice.id,
  processId: 0
});

await capture.start();
console.log('Capturing from:', capture.getDeviceId());
```

### 3. Get Default Device

Retrieve the system default audio device:

```javascript
const defaultDeviceId = await AudioCapture.getDefaultDeviceId();
console.log('Default device:', defaultDeviceId);

// Use it explicitly
const capture = new AudioCapture({
  deviceId: defaultDeviceId,
  processId: 0
});
```

### 4. Multi-Device Capture

Capture multiple devices simultaneously:

```javascript
const devices = await AudioCapture.getAudioDevices();

// Create capture instance for each device
const captures = devices.map(device => {
  const capture = new AudioCapture({
    deviceId: device.id,
    processId: 0
  });
  
  capture.on('data', (event) => {
    console.log(`[${device.name}] Captured ${event.length} bytes`);
  });
  
  return { device, capture };
});

// Start all captures
for (const { capture } of captures) {
  await capture.start();
}
```

### 5. Device + Process Filter Combination

Combine device selection with process filtering:

```javascript
const devices = await AudioCapture.getAudioDevices();
const processes = await AudioCapture.getProcesses();

const targetDevice = devices[0];
const chromeProcess = processes.find(p => p.name === 'chrome.exe');

// Capture Chrome audio from specific device
const capture = new AudioCapture({
  deviceId: targetDevice.id,
  processId: chromeProcess.pid,
  loopbackMode: 1
});

await capture.start();
```

---

## ğŸ“‹ Complete API Reference

### Static Methods

#### `AudioCapture.getAudioDevices()`

**Type**: `() => Promise<AudioDeviceInfo[]>`

**Description**: Returns all available audio output devices.

**Returns**: Array of `AudioDeviceInfo` objects

**Example**:
```javascript
const devices = await AudioCapture.getAudioDevices();
```

---

#### `AudioCapture.getDefaultDeviceId()`

**Type**: `() => Promise<string | null>`

**Description**: Returns the ID of the system default audio output device.

**Returns**: Device ID string, or `null` if no default device

**Example**:
```javascript
const defaultId = await AudioCapture.getDefaultDeviceId();
```

---

### Constructor Options

#### `deviceId` (optional)

**Type**: `string`

**Description**: Specifies which audio device to capture from. If omitted, uses the system default device.

**Example**:
```javascript
new AudioCapture({
  deviceId: '{0.0.0.00000000}.{guid}',
  processId: 0
});
```

---

### Instance Methods

#### `getDeviceId()`

**Type**: `() => string | undefined`

**Description**: Returns the device ID currently in use.

**Returns**: Device ID string, or `undefined` if using default device

**Example**:
```javascript
const capture = new AudioCapture({ deviceId: 'xxx' });
console.log(capture.getDeviceId()); // 'xxx'
```

---

### TypeScript Definitions

#### `AudioDeviceInfo` Interface

```typescript
interface AudioDeviceInfo {
  /**
   * Unique device identifier (persistent across reboots)
   * Format: {0.0.0.00000000}.{GUID}
   * @since 2.3.0
   */
  id: string;

  /**
   * Device friendly name
   * @example "Realtek High Definition Audio"
   */
  name: string;

  /**
   * Device description
   * @example "Speakers (Realtek High Definition Audio)"
   */
  description: string;

  /**
   * Whether this is the system default output device
   */
  isDefault: boolean;

  /**
   * Whether the device is currently active (connected and enabled)
   */
  isActive: boolean;
}
```

#### Updated `AudioCaptureOptions`

```typescript
interface AudioCaptureOptions {
  processId: number;        // Required: 0 for all system audio
  deviceId?: string;        // Optional: specific device ID (v2.3+)
  sampleRate?: number;      // Optional: 16000, 44100, 48000
  bitsPerSample?: number;   // Optional: 16 or 32
  channels?: number;        // Optional: 1 (mono) or 2 (stereo)
  loopbackMode?: 0 | 1;     // Optional: 0=include, 1=exclude (v2.0+)
}
```

---

## ğŸ”§ Implementation Details

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           JavaScript API Layer              â”‚
â”‚  (lib/audio-capture.js)                     â”‚
â”‚  - getAudioDevices()                        â”‚
â”‚  - getDefaultDeviceId()                     â”‚
â”‚  - deviceId validation                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           N-API Bindings Layer              â”‚
â”‚  (src/napi/device_manager.cpp)              â”‚
â”‚  - GetAudioDevices()                        â”‚
â”‚  - GetDefaultDeviceId()                     â”‚
â”‚  - VerifyDeviceId()                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          C++ WASAPI Layer                   â”‚
â”‚  (src/wasapi/device_enumerator.cpp)         â”‚
â”‚  - AudioDeviceEnumerator class              â”‚
â”‚  - IMMDeviceEnumerator COM interface        â”‚
â”‚  - Device property reading                  â”‚
â”‚  - UTF-8 â†” UTF-16 conversion                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technical Stack

- **COM Initialization**: `CoInitializeEx(nullptr, COINIT_APARTMENTTHREADED)`
- **Device Enumeration**: `IMMDeviceEnumerator::EnumAudioEndpoints()`
- **Device Properties**: `IPropertyStore` with `PKEY_Device_FriendlyName`, `PKEY_Device_DeviceDesc`
- **String Conversion**: `WideCharToMultiByte()` for UTF-8 support
- **Memory Management**: Smart pointers (`Microsoft::WRL::ComPtr`)

### File Changes

**New Files** (5 files, 662 lines):
- `src/wasapi/device_enumerator.h` (90 lines)
- `src/wasapi/device_enumerator.cpp` (245 lines)
- `src/napi/device_manager.cpp` (127 lines)
- `examples/device-selection.js` (145 lines)
- `docs/device-selection.md` (400+ lines)

**Modified Files** (4 files):
- `lib/audio-capture.js` - Added device selection methods
- `index.d.ts` - Added TypeScript definitions
- `src/napi/addon.cpp` - Added InitDeviceManager()
- `binding.gyp` - Added new source files

**Documentation**:
- `docs/device-selection.md` - Complete feature guide
- `docs/V2.3_RELEASE_NOTES.md` - This file
- `README.md` - Updated with v2.3 section
- `CHANGELOG.md` - v2.3.0 entry

---

## âš¡ Performance

### Device Enumeration

| Operation | Time (ms) | Notes |
|-----------|-----------|-------|
| COM Initialization | <1ms | One-time cost |
| Enumerate Devices | 5-10ms | For 4-8 devices |
| Get Device Properties | 1-2ms | Per device |
| Total (first call) | 8-15ms | Includes COM init |
| Total (subsequent) | 5-10ms | COM already initialized |

### Device Validation

| Operation | Time (ms) | Notes |
|-----------|-----------|-------|
| Valid Device ID | 2-5ms | Check + device info |
| Invalid Device ID | 1-2ms | Fail fast |

### Capture Overhead

| Scenario | Overhead | Notes |
|----------|----------|-------|
| No deviceId specified | 0ms | Same as v2.2 |
| With deviceId | <1ms | Minimal validation cost |

---

## ğŸ”„ Migration Guide

### From v2.2.x to v2.3.0

**Good News**: No migration needed! v2.3.0 is 100% backward compatible.

#### Existing Code (Still Works)

```javascript
// v2.2.x code - continues to work in v2.3.0
const capture = new AudioCapture({
  processId: 0
});
```

This will use the system default audio device, exactly as in v2.2.x.

#### Adding Device Selection (Optional)

```javascript
// v2.3.0 - add device selection if needed
const devices = await AudioCapture.getAudioDevices();
const capture = new AudioCapture({
  processId: 0,
  deviceId: devices[0].id  // NEW in v2.3
});
```

### TypeScript Users

Update your imports to include new types:

```typescript
import {
  AudioCapture,
  AudioDeviceInfo,        // NEW in v2.3
  AudioCaptureOptions
} from 'node-windows-audio-capture';

const devices: AudioDeviceInfo[] = await AudioCapture.getAudioDevices();
```

---

## ğŸ¯ Use Cases

### 1. User Device Selection

Allow users to choose their preferred audio device:

```javascript
const devices = await AudioCapture.getAudioDevices();

// Display to user
console.log('Select an audio device:');
devices.forEach((device, index) => {
  console.log(`${index + 1}. ${device.name}`);
});

// User selects device 1
const selectedDevice = devices[0];

const capture = new AudioCapture({
  deviceId: selectedDevice.id,
  processId: 0
});
```

### 2. Multi-Device Audio Monitoring

Monitor audio from all devices:

```javascript
const devices = await AudioCapture.getAudioDevices();

for (const device of devices) {
  const capture = new AudioCapture({
    deviceId: device.id,
    processId: 0
  });
  
  capture.on('data', (event) => {
    console.log(`[${device.name}] ${event.length} bytes`);
  });
  
  await capture.start();
}
```

### 3. Hardware-Specific Capture

Capture from specific audio hardware:

```javascript
const devices = await AudioCapture.getAudioDevices();

// Find USB audio interface
const usbDevice = devices.find(d => 
  d.name.includes('USB') || d.description.includes('USB')
);

if (usbDevice) {
  const capture = new AudioCapture({
    deviceId: usbDevice.id,
    processId: 0
  });
  await capture.start();
}
```

### 4. Application-Specific Device + Process

Capture Chrome from specific device:

```javascript
const devices = await AudioCapture.getAudioDevices();
const processes = await AudioCapture.getProcesses();

const hdmiDevice = devices.find(d => d.name.includes('HDMI'));
const chrome = processes.find(p => p.name === 'chrome.exe');

if (hdmiDevice && chrome) {
  const capture = new AudioCapture({
    deviceId: hdmiDevice.id,
    processId: chrome.pid,
    loopbackMode: 1
  });
  await capture.start();
}
```

---

## âœ… Testing

### Test Coverage

- âœ… C++ Layer: Device enumeration, COM initialization, UTF-8 conversion
- âœ… N-API Layer: JavaScript object creation, error handling
- âœ… JavaScript API: Static methods, constructor validation
- âœ… TypeScript: Type definitions, interface validation
- âœ… Examples: 4 usage scenarios tested

### Test Results

```
âœ“ Device enumeration returns array of devices
âœ“ Default device ID retrieval
âœ“ Device ID validation (valid IDs)
âœ“ Device ID validation (invalid IDs)
âœ“ AudioCapture constructor with deviceId
âœ“ Multiple concurrent captures (4 devices)
âœ“ Device + process filter combination
```

### Known Issues

1. **Device ID Verification Logs Error**
   - **Issue**: `verifyDeviceId()` logs E_INVALIDARG (0x80070057) for invalid IDs
   - **Impact**: Low (logs only, doesn't affect functionality)
   - **Status**: Expected behavior, returns false correctly
   - **Priority**: Low

---

## ğŸ“š Documentation

### New Documentation

- [Device Selection Guide](./device-selection.md) - Complete feature guide with examples
- [Device Selection Example](../examples/device-selection.js) - 4 practical examples

### Updated Documentation

- [README.md](../README.md) - v2.3 feature section
- [CHANGELOG.md](../CHANGELOG.md) - v2.3.0 entry
- [API Documentation](./api.md) - Updated with device selection APIs

---

## ğŸ”® Future Enhancements (v2.4+)

### Planned Features

1. **Device Events** (v2.4)
   - Device connected/disconnected notifications
   - Default device changed event
   - Device property changed event

2. **Audio Input Device Support** (v2.4)
   - Microphone enumeration
   - Input device capture
   - Input + output combined capture

3. **Device Monitoring** (v2.5)
   - Real-time device status updates
   - Device usage statistics
   - Audio level monitoring per device

4. **Advanced Device Control** (v2.5)
   - Device volume control
   - Device mute/unmute
   - Device exclusive mode support

---

## ğŸ¤ Contributing

Device selection is part of our v2.3 milestone. We welcome contributions!

### How to Contribute

1. Check [Issues](https://github.com/your-repo/issues) for open tasks
2. Fork the `feature/device-selection` branch
3. Make your changes
4. Submit a pull request

### Areas for Contribution

- ğŸ“ Documentation improvements
- ğŸ§ª Additional test cases
- ğŸ› Bug reports and fixes
- ğŸ’¡ Feature suggestions

---

## ğŸ“– See Also

- [v2.2 Release Notes](./V2.2_RELEASE_NOTES.md) - Audio format conversion
- [v2.1 Release Notes](./V2.1_RELEASE_NOTES.md) - Mute control
- [FAQ](./FAQ.md) - Common questions
- [Troubleshooting](./troubleshooting.md) - Problem resolution

---

## ğŸ“ Support

- **GitHub Issues**: Report bugs or request features
- **Documentation**: Complete guides in `docs/` folder
- **Examples**: Working code in `examples/` folder

---

**Thank you for using node-windows-audio-capture! ğŸ‰**
