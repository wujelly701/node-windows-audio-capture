# Buffer Pool Statistics API - Implementation Summary

## 完成时间
2025-10-15

## 实现内容

### 1. C++ 实现

#### `GetPoolStats()` 方法 (audio_processor.cpp)
```cpp
Napi::Value AudioProcessor::GetPoolStats(const Napi::CallbackInfo& info) {
    Napi::Env env = info.Env();
    
    if (!useExternalBuffer_) {
        // Not using external buffer mode - return null
        return env.Null();
    }
    
    // Get statistics from ExternalBufferFactory
    auto stats = ExternalBufferFactory::Instance().GetStats();
    
    // Create JavaScript object with statistics
    Napi::Object result = Napi::Object::New(env);
    result.Set("poolHits", Napi::Number::New(env, stats.pool_hits));
    result.Set("poolMisses", Napi::Number::New(env, stats.pool_misses));
    result.Set("dynamicAllocations", Napi::Number::New(env, stats.dynamic_allocations));
    result.Set("currentPoolSize", Napi::Number::New(env, stats.current_pool_size));
    result.Set("maxPoolSize", Napi::Number::New(env, stats.max_pool_size));
    
    // Calculate hit rate
    uint64_t total_requests = stats.pool_hits + stats.pool_misses;
    double hit_rate = (total_requests > 0) ? 
        (static_cast<double>(stats.pool_hits) / total_requests * 100.0) : 0.0;
    result.Set("hitRate", Napi::Number::New(env, hit_rate));
    
    return result;
}
```

#### JavaScript 绑定
- 添加到 `AudioProcessor::DefineClass()`:
  ```cpp
  InstanceMethod("getPoolStats", &AudioProcessor::GetPoolStats)
  ```

### 2. JavaScript 包装器

#### index.js
```javascript
getPoolStats() {
    if (!this._processor) {
        throw new Error('AudioProcessor not initialized');
    }
    
    try {
        return this._processor.getPoolStats();
    } catch (error) {
        throw new Error(`Failed to get pool statistics: ${error.message}`);
    }
}
```

#### lib/audio-capture.js
```javascript
getPoolStats() {
    try {
        return this._processor.getPoolStats();
    } catch (error) {
        throw new Error(`Failed to get pool statistics: ${error.message}`);
    }
}
```

### 3. 返回值格式

#### 非零拷贝模式
```javascript
null
```

#### 零拷贝模式
```javascript
{
  poolHits: 10,              // 从缓冲池成功获取的次数
  poolMisses: 490,           // 缓冲池为空，回退到动态分配的次数
  dynamicAllocations: 490,   // 动态分配的总次数
  currentPoolSize: 0,        // 当前缓冲池中可用缓冲区数量
  maxPoolSize: 10,           // 缓冲池最大容量
  hitRate: 2.00              // 命中率百分比 (0-100)
}
```

## 重要Bug修复

### 问题1: 零拷贝模式崩溃
**症状**: 启用零拷贝后，程序在接收音频数据时立即崩溃

**原因**: 
1. `ExternalBufferFactory` 未初始化就使用
2. `ToBuffer()` 没有支持自定义大小参数
3. 实际数据大小（3840字节）小于缓冲区大小（4096字节）

**修复**:
1. 在 `AudioProcessor` 构造函数中显式初始化 Factory:
   ```cpp
   if (useExternalBuffer_) {
       ExternalBufferFactory::Instance().Initialize(4096, 10);
   }
   ```

2. 添加 `ToBuffer(size_t actual_size)` 重载:
   ```cpp
   Napi::Value ExternalBuffer::ToBuffer(Napi::Env env, size_t actual_size)
   ```

3. 修改 `OnAudioData()` 传递实际数据大小:
   ```cpp
   size_t actualSize = data.size();
   memcpy(extBuffer->data(), data.data(), actualSize);
   // ...
   Napi::Value buffer = rawPtr->ToBuffer(env, actualSize);
   ```

## 测试结果

### 测试脚本: test-pool-stats.js
```
Initial stats: all zeros (pool not yet used)

After 5 seconds of capture:
- Total packets: 500
- Pool hits: 10
- Pool misses: 490
- Hit rate: 2.00%
- Current pool size: 0/10
```

### 性能分析
- **吞吐量**: 约100个数据包/秒
- **数据包大小**: 3840字节
- **命中率低原因**: 
  - 默认池大小（10个缓冲区）远小于需求
  - 建议增加到100个缓冲区以匹配每秒数据包数量

## API 使用示例

```javascript
const { AudioCapture } = require('node-windows-audio-capture');

const capture = new AudioCapture({
    processId: 0,
    useExternalBuffer: true  // 启用零拷贝模式
});

// 初始统计
const initialStats = capture.getPoolStats();
console.log('Initial:', initialStats);

capture.on('data', (buffer) => {
    // 处理音频数据
});

capture.start();

// 运行时统计
setInterval(() => {
    const stats = capture.getPoolStats();
    console.log(`Hit rate: ${stats.hitRate.toFixed(2)}%`);
    console.log(`Pool size: ${stats.currentPoolSize}/${stats.maxPoolSize}`);
}, 1000);
```

## 下一步优化建议

1. **增加默认池大小**: 从10改为100
2. **动态池大小**: 根据吞吐量自动调整
3. **池大小配置**: 允许用户在构造时指定池大小
4. **性能预警**: 当命中率<50%时发出警告

## 相关文件

- `src/napi/audio_processor.h` - GetPoolStats() 声明
- `src/napi/audio_processor.cpp` - GetPoolStats() 实现
- `src/napi/external_buffer.h` - ToBuffer(actual_size) 声明
- `src/napi/external_buffer.cpp` - ToBuffer(actual_size) 实现
- `index.js` - JavaScript 包装器
- `lib/audio-capture.js` - 替代包装器
- `test-pool-stats.js` - 测试脚本
