# v2.9.0 Release Notes - 麦克风捕获 + ASR 质量提升

**发布日期**: 2025-10-17  
**版本**: v2.9.0  
**状态**: ✅ 稳定版

---

## 📋 概览

v2.9.0 引入了**麦克风捕获 API**，并**大幅提升 ASR 音频质量**，使 `node-windows-audio-capture` 成为 Windows 平台最完整的音频捕获解决方案。

### 🎯 核心改进

1. **🎙️ 麦克风捕获 API** - 新增 `MicrophoneCapture` 类
2. **🔊 ASR 重采样升级** - Linear → Sinc 插值（显著改善音质）
3. **📖 完整文档** - 新增麦克风 API 文档和示例

---

## 🎙️ 新特性：麦克风捕获 API

### 1. MicrophoneCapture 类

**新增高级 API**，用于麦克风音频捕获：

```javascript
const { MicrophoneCapture } = require('node-windows-audio-capture');

const mic = new MicrophoneCapture({
  deviceId: '{device-id}',  // 可选：选择特定麦克风
  denoise: true,             // RNNoise 降噪
  agc: true,                 // 自动增益控制
  eq: true                   // 3-Band 均衡器
});

mic.on('data', (buffer) => {
  // 处理麦克风音频数据
});

await mic.start();
```

### 2. 设备选择

**支持选择特定麦克风设备**：

```javascript
const { listDevices } = require('node-windows-audio-capture');

// 列出所有音频设备
const devices = await listDevices();

// 筛选麦克风设备（非 Loopback）
const microphones = devices.filter(d => !d.isLoopback);

console.log('可用麦克风:');
microphones.forEach(mic => {
  console.log(`  ${mic.name} (ID: ${mic.id})`);
});

// 使用特定麦克风
const mic = new MicrophoneCapture({
  deviceId: microphones[0].id
});
```

### 3. 集成音频效果

**与系统音频捕获相同的音频效果**：

- **RNNoise 降噪**: AI 降噪，消除背景噪音
- **AGC (自动增益)**: 自动调整音量，< 5ms 延迟
- **3-Band EQ**: 低/中/高频均衡器（-20~+20dB）

```javascript
const mic = new MicrophoneCapture({
  denoise: true,
  denoiseStrength: 0.8,  // 0-1, 默认 0.5
  
  agc: true,
  agcTarget: -16,        // dB, 默认 -16dB
  
  eq: true,
  eqLowGain: -3,         // 低频 -3dB
  eqMidGain: 5,          // 中频 +5dB
  eqHighGain: 2          // 高频 +2dB
});
```

### 4. WASAPI 直接捕获模式

**底层实现**：
- 使用 WASAPI 直接捕获模式（`isLoopback = false`）
- 捕获麦克风物理输入，而非系统音频环回
- 与 `AudioCapture` 相同的底层架构，质量可靠

---

## 🔊 改进：ASR 重采样质量升级

### 1. Sinc 插值替代线性插值

**AudioProcessingPipeline 重采样升级**：

| 版本 | 重采样算法 | 音质 | 适用场景 |
|------|-----------|------|---------|
| v2.2 - v2.8 | Linear（线性插值） | ⭐⭐⭐ | 一般场景 |
| **v2.9** | **Sinc (Kaiser-windowed)** | ⭐⭐⭐⭐⭐ | **ASR/生产** ✅ |

**改进效果**：
- ✅ 48kHz → 16kHz 降采样时，音频失真显著减少
- ✅ 频域保持更好，混叠失真最小化
- ✅ 提高 ASR 识别准确率
- ✅ 性能开销 < 0.2ms，几乎无影响

### 2. 自动应用到 ASR 预设

**所有 ASR 预设自动升级**：

```javascript
const { AudioProcessingPipeline } = require('node-windows-audio-capture');

// 以下预设自动使用 Sinc 插值（v2.9.0+）
const pipeline1 = new AudioProcessingPipeline('china-asr');      // ✅ Sinc
const pipeline2 = new AudioProcessingPipeline('openai-whisper'); // ✅ Sinc
const pipeline3 = new AudioProcessingPipeline('azure');          // ✅ Sinc
const pipeline4 = new AudioProcessingPipeline('google');         // ✅ Sinc
```

**无需代码更改**，自动受益！

### 3. 手动配置支持

**自定义重采样质量**：

```javascript
const pipeline = new AudioProcessingPipeline({
  targetSampleRate: 16000,
  targetChannels: 1,
  resamplingQuality: 'sinc'  // 'simple' | 'linear' | 'sinc'
});
```

**质量对比**：

| Quality | Algorithm | Audio Quality | CPU | Latency |
|---------|-----------|---------------|-----|---------|
| `simple` | Direct sampling | ⭐ | 最低 | < 0.05ms |
| `linear` | Linear interpolation | ⭐⭐⭐ | 低 | < 0.1ms |
| **`sinc`** | Kaiser-windowed Sinc | ⭐⭐⭐⭐⭐ | 中 | < 0.2ms |

---

## 📖 新增文档

### 1. API 文档更新

**`docs/api.md`** 新增章节：
- `MicrophoneCapture` 类完整文档
- 构造函数参数说明
- 事件和错误处理
- 完整示例代码

### 2. 示例代码

**`examples/microphone-capture.js`** - 完整麦克风捕获示例：
- 设备列表和选择
- 音频效果配置
- ASR 格式转换
- 错误处理

---

## 🎯 使用场景

### 1. 麦克风捕获 + ASR

**完整的语音识别解决方案**：

```javascript
const { MicrophoneCapture, AudioProcessingPipeline } = require('node-windows-audio-capture');

// 录制麦克风
const mic = new MicrophoneCapture({
  denoise: true,
  agc: true
});

// 转换为 ASR 格式
const asrPipeline = new AudioProcessingPipeline('china-asr');  // 自动 Sinc 插值

mic.on('data', (buffer) => {
  // 高质量 ASR 音频
  const asrData = asrPipeline.process(buffer);
  sendToASR(asrData);  // 发送到百度/腾讯/阿里 ASR
});

await mic.start();
```

### 2. 实时翻译软件

**麦克风输入 + 实时识别**：

```javascript
// 录制用户语音
const mic = new MicrophoneCapture({
  denoise: true,
  agc: true,
  eq: true
});

// 处理音频流
const pipeline = new AudioProcessingPipeline('openai-whisper');

mic.on('data', async (buffer) => {
  const asrData = pipeline.process(buffer);
  const text = await whisperAPI.recognize(asrData);
  const translation = await translateAPI.translate(text);
  console.log('翻译:', translation);
});
```

### 3. 会议录音

**高质量录音 + 降噪**：

```javascript
const mic = new MicrophoneCapture({
  denoise: true,
  denoiseStrength: 0.8,
  agc: true,
  agcTarget: -16
});

const fs = require('fs');
const output = fs.createWriteStream('meeting-recording.pcm');

mic.pipe(output);
await mic.start();
```

---

## 🔄 向后兼容性

### ✅ 100% 向后兼容

- **新 API**: `MicrophoneCapture` 是纯新增功能
- **现有代码**: 无需任何更改
- **ASR 质量**: 自动升级，透明改进
- **性能**: 影响可忽略（< 0.2ms）

### 迁移指南

**无需迁移** - 现有代码继续工作，同时自动受益于 ASR 质量提升！

如果需要使用新的麦克风捕获功能：

```javascript
// 之前：系统音频捕获
const { AudioCapture } = require('node-windows-audio-capture');
const capture = new AudioCapture({ processId: 0 });

// 现在：麦克风捕获（新增）
const { MicrophoneCapture } = require('node-windows-audio-capture');
const mic = new MicrophoneCapture();  // 相同的 API 设计
```

---

## 📊 性能影响

### Sinc 插值性能测试

| 测试场景 | 处理时间 | 音频时长 | 实时率 |
|---------|---------|---------|--------|
| 48kHz → 16kHz | 111ms | 20s | **180x** ⚡ |
| Sinc 初始化 | 4ms | - | 一次性 |
| 增量延迟 | < 0.2ms | 每帧 | 可忽略 |

**结论**: Sinc 插值带来显著音质提升，性能开销几乎为零。

---

## 🐛 已知限制

### 1. 物理录音场景

**限制**：麦克风捕获 + 手机扬声器播放（空气传播）
- 音质受物理环境影响（距离、噪音、麦克风质量）
- 软件层面已优化到极限（Sinc + 降噪 + AGC）

**建议**：
- 使用外置 USB 麦克风（更高灵敏度）
- 使用音频线直连（手机 3.5mm → 电脑线路输入）
- 减少环境噪音，靠近音源

### 2. 设备兼容性

**要求**：
- Windows 10/11
- 麦克风设备支持 WASAPI 直接捕获模式
- 大多数现代麦克风均支持

---

## 🚀 下一步计划

### v2.10.0（规划中）

- **多声道麦克风**: 支持 5.1/7.1 声道麦克风阵列
- **VAD 增强**: 更精确的语音活动检测
- **实时统计**: 麦克风音频电平监控 API

---

## 📚 相关文档

- [完整 API 文档](api.md) - MicrophoneCapture 详细说明
- [快速开始指南](QUICK_START_GUIDE.md) - 30 秒上手
- [翻译软件集成](TRANSLATION_SOFTWARE_INTEGRATION.md) - 实时翻译完整方案
- [ASR 兼容性路线图](ASR_COMPATIBILITY_ROADMAP.md) - ASR 格式要求

---

## 🙏 致谢

感谢所有用户的反馈和建议，v2.9.0 的改进直接来源于社区的实际需求。

特别感谢：
- **RNNoise** - Xiph.org 的开源 AI 降噪库
- **WASAPI** - Microsoft 的高质量音频 API
- **Kaiser-windowed Sinc** - 业界最优的重采样算法

---

## 📦 安装

```bash
npm install node-windows-audio-capture@2.9.0
```

或从源码构建：

```bash
git clone https://github.com/wujelly701/node-windows-audio-capture.git
cd node-windows-audio-capture
git checkout v2.9.0
npm install
npm run build
```

---

**完整更新日志**: [CHANGELOG.md](../CHANGELOG.md)  
**GitHub Release**: [v2.9.0](https://github.com/wujelly701/node-windows-audio-capture/releases/tag/v2.9.0)
