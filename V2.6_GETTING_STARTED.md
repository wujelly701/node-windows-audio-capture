# v2.6 开发启动指南

## 🚀 快速开始

v2.6 开发已经开始！这个版本专注于**内存与生态优化**。

## ✅ 当前状态检查

### 已完成的准备工作
- ✅ v2.5.0 已成功发布并合并到 main 分支
- ✅ 开发计划文档已创建 (`V2.6_DEVELOPMENT_PLAN.md`)
- ✅ GitHub Actions 工作流已配置
  - `test.yml` - 自动化测试
  - `prebuild.yml` - 预构建二进制
  - `release.yml` - 发布流程
- ✅ package.json 已配置 npm 发布字段
- ✅ .npmignore 已存在

### 需要立即开始的任务

## 📋 第一阶段任务清单（Week 1）

### 任务 1: 创建开发分支 ⭐ 立即执行
```powershell
# 确保在 main 分支并且是最新的
git checkout main
git pull origin main

# 创建 v2.6 开发分支
git checkout -b feature/v2.6-development

# 推送到远程
git push -u origin feature/v2.6-development
```

### 任务 2: 安装额外开发依赖
```powershell
# 安装 V8 profiler（内存分析）
npm install --save-dev v8-profiler-next

# 安装 benchmark 工具
npm install --save-dev benchmark

# 验证安装
npm list --depth=0
```

### 任务 3: 更新 .npmignore
需要确保以下文件不被发布：

**排除的开发文档**：
```
V2.6_DEVELOPMENT_PLAN.md
V2.6_MEMORY_ANALYSIS.md
COMPLETION_REPORT.md
PROCESS_LOOPBACK_*.md
```

**排除的测试文件**：
```
test-*.js
diagnose-*.js
check-*.js
fix-*.js
find-*.js
simple-test-*.js
```

**保留的文件**：
```
README.md
LICENSE
CHANGELOG.md
docs/api.md
docs/FAQ.md
docs/troubleshooting.md
examples/basic.js
examples/format-conversion-example.js
```

### 任务 4: 验证 package.json 配置

检查以下字段：

```json
{
  "name": "node-windows-audio-capture",
  "version": "2.6.0",  // ⚠️ 需要更新
  "files": [
    "index.js",
    "index.d.ts",
    "binding.gyp",
    "src/**/*.h",
    "src/**/*.cpp",
    "lib/**/*.js",  // ⚠️ 需要添加
    "examples/basic.js",
    "examples/format-conversion-example.js",
    "examples/error-handling.js",
    "examples/stream-processing.js",
    "README.md",
    "LICENSE",
    "CHANGELOG.md"
  ],
  "engines": {
    "node": ">=16.0.0"
  },
  "os": ["win32"],
  "publishConfig": {
    "access": "public",
    "registry": "https://registry.npmjs.org/"
  }
}
```

### 任务 5: 创建 CHANGELOG.md
```markdown
# Changelog

## [2.6.0] - TBD

### Added
- AGC (Automatic Gain Control) support
- Noise Gate (threshold-based noise reduction)
- Extended sample rate support (8kHz, 24kHz, 32kHz)
- npm package available
- Prebuilt binaries for Node.js 16/18/20/22
- GitHub Actions CI/CD

### Improved
- Memory usage optimization
- V8 GC behavior analysis and documentation
- Build and release process

### Documentation
- V2.6 Memory Analysis Report
- Audio Effects Processing Guide
- npm Publishing Guide

## [2.5.0] - 2025-10-15
... (保留现有内容)
```

---

## 🎯 本周目标（Week 1）

### 优先级 P0 任务

#### 1. npm 发布准备（2天）
- [ ] 更新 package.json 版本到 2.6.0-alpha.1
- [ ] 完善 .npmignore
- [ ] 本地测试 `npm pack`
- [ ] 创建 npmjs.com 账号（如未有）
- [ ] 首次测试发布 alpha 版本

**验收标准**：
```powershell
# 打包测试
npm pack

# 检查包内容
tar -tzf node-windows-audio-capture-2.6.0-alpha.1.tgz

# 确保包含：
# - package/index.js
# - package/index.d.ts
# - package/binding.gyp
# - package/src/**
# - package/lib/**
# - package/README.md
# - package/LICENSE

# 不应包含：
# - package/test/
# - package/V2.6_*.md
# - package/test-*.js
```

#### 2. GitHub Actions 测试（1天）
- [ ] 推送代码触发 test.yml
- [ ] 验证所有 Node.js 版本测试通过
- [ ] 修复任何 CI 失败

**验收标准**：
- ✅ Node.js 16.x 测试通过
- ✅ Node.js 18.x 测试通过
- ✅ Node.js 20.x 测试通过
- ✅ Node.js 22.x 测试通过

#### 3. 预构建二进制测试（2天）
- [ ] 触发 prebuild.yml 工作流
- [ ] 验证生成的 .node 文件
- [ ] 测试不同 Node.js 版本加载预构建二进制
- [ ] 文档：如何使用预构建二进制

**验收标准**：
```powershell
# 用户安装体验（无需编译）
npm install node-windows-audio-capture@2.6.0-alpha.1
node -e "console.log(require('node-windows-audio-capture'))"
# ✅ 应该成功加载，无需 node-gyp
```

---

## 🔧 开发工具设置

### 1. V8 Profiler 使用
```javascript
// memory-profile.js
const v8Profiler = require('v8-profiler-next');
const AudioCapture = require('./index');

// 开始 profiling
v8Profiler.startProfiling('audio-capture', true);

// 运行测试
const capture = new AudioCapture({ processId: 0 });
capture.start();

setTimeout(() => {
  // 结束 profiling
  const profile = v8Profiler.stopProfiling();
  profile.export((error, result) => {
    require('fs').writeFileSync('memory-profile.cpuprofile', result);
    profile.delete();
    console.log('✅ Profile saved to memory-profile.cpuprofile');
    capture.stop();
  });
}, 60000); // 1分钟测试
```

### 2. 内存泄漏检测
```javascript
// memory-leak-test.js
const AudioCapture = require('./index');

let peakMemory = 0;
let baseMemory = process.memoryUsage().heapUsed;

setInterval(() => {
  const mem = process.memoryUsage();
  if (mem.heapUsed > peakMemory) peakMemory = mem.heapUsed;
  
  console.log({
    heapUsed: (mem.heapUsed / 1024 / 1024).toFixed(2) + ' MB',
    peak: (peakMemory / 1024 / 1024).toFixed(2) + ' MB',
    growth: ((mem.heapUsed - baseMemory) / 1024 / 1024).toFixed(2) + ' MB'
  });
  
  if (global.gc) global.gc();
}, 5000);

// 长时间运行测试
const capture = new AudioCapture({ processId: 0 });
capture.start();

// 1小时后停止
setTimeout(() => {
  capture.stop();
  console.log('✅ 测试完成');
  process.exit(0);
}, 3600000);
```

运行：
```powershell
node --expose-gc memory-leak-test.js
```

---

## 📊 成功指标

### Week 1 结束时应该达成：
- [ ] npm alpha 版本可以安装
- [ ] CI/CD 工作流全部通过
- [ ] 预构建二进制可用（至少一个 Node.js 版本）
- [ ] 内存基线数据收集完成

### 代码质量：
- [ ] 测试覆盖率 ≥ 85%
- [ ] 所有测试通过
- [ ] 无编译警告

### 文档：
- [ ] CHANGELOG.md 创建
- [ ] V2.6 开发进度记录

---

## 🚨 注意事项

### 关键决策点

1. **零拷贝架构**
   - 如果实现复杂度高，考虑延后到 v2.7
   - 优先保证 AGC 和 Noise Gate 功能完成

2. **预构建二进制策略**
   - 初期只支持 Windows x64
   - arm64 支持可以延后

3. **npm 发布**
   - 使用 alpha 版本测试发布流程
   - 正式版本前至少发布 3 个 alpha/beta 版本

---

## 📞 遇到问题？

### 常见问题

**Q: GitHub Actions 构建失败？**
A: 检查 Windows Server 环境是否有 Visual Studio 和 SDK

**Q: npm pack 包含了不该有的文件？**
A: 更新 .npmignore 或 package.json 的 files 字段

**Q: 预构建二进制加载失败？**
A: 检查 N-API 版本兼容性，确保 node-gyp-build 正确配置

---

## 🎉 准备好了！

现在执行第一个命令开始开发：

```powershell
# 1. 创建开发分支
git checkout -b feature/v2.6-development

# 2. 更新版本号（手动编辑 package.json）
# "version": "2.6.0-alpha.1"

# 3. 提交并推送
git add .
git commit -m "chore: start v2.6 development"
git push -u origin feature/v2.6-development
```

**让我们开始吧！** 🚀

---

*创建时间: 2025-10-15*  
*预计完成 Week 1: 2025-10-22*
