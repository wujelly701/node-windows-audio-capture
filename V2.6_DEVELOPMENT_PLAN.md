# node-windows-audio-capture v2.6 开发计划

## 📋 版本概述

**版本号**: v2.6.0  
**代号**: **Memory & Ecosystem Optimization（内存与生态优化版）**  
**开发周期**: 预计 2-3 周  
**发布目标**: 2025年11月初

---

## 🎯 核心目标

v2.6 专注于三个方向：

1. **内存优化** 🔧 - 减少内存分配，提升长时间运行稳定性
2. **生态完善** 📦 - npm 发布、CI/CD、预构建二进制
3. **功能扩展** 🎵 - 音频效果处理（降噪、AGC、均衡器）

---

## 📊 优先级排序

### P0 - 必须完成（核心功能）

1. **npm 发布和 CI/CD 配置** ⭐⭐⭐
   - 目标：让用户可以直接 `npm install node-windows-audio-capture`
   - 影响：极大提升项目可用性和传播度
   - 工作量：中等（3-5天）

2. **预构建二进制优化** ⭐⭐⭐
   - 目标：支持 Node.js 16/18/20/22，Electron 常见版本
   - 影响：用户无需编译环境即可使用
   - 工作量：中等（3-4天）

3. **V8 GC 行为深度分析** ⭐⭐
   - 目标：理解实际负载下的内存使用模式
   - 影响：为零拷贝优化提供数据支持
   - 工作量：中等（2-3天）

### P1 - 应该完成（重要优化）

4. **零拷贝流式架构探索** ⭐⭐
   - 目标：减少 Buffer 拷贝，降低 GC 压力
   - 影响：长时间运行性能提升
   - 工作量：高（5-7天）
   - 风险：可能需要破坏性 API 变更

5. **音频效果处理基础框架** ⭐
   - 目标：实现 AGC（自动增益控制）
   - 影响：为 LLM 翻译软件提供底层支持
   - 工作量：中等（3-4天）

### P2 - 可以完成（增强功能）

6. **更多采样率支持**
   - 目标：8kHz、24kHz、32kHz
   - 影响：支持更多 ASR 服务
   - 工作量：低（1-2天）

7. **基础降噪处理**
   - 目标：简单的门限降噪（Noise Gate）
   - 影响：提升音频质量
   - 工作量：中等（2-3天）

---

## 🗓️ 开发阶段规划

### 第一阶段：生态建设（Week 1）

**目标**：让项目可以被全球开发者使用

#### 任务 1.1：npm 发布配置（2天）
- [ ] 创建 npmjs.com 账号并验证
- [ ] 配置 `.npmignore`（排除测试文件、临时文档）
- [ ] 更新 `package.json` 发布配置
  - `files` 字段：包含必需文件
  - `publishConfig` 配置
  - `engines` 限制 Node.js 版本
- [ ] 本地测试 `npm pack` 生成包
- [ ] 首次发布 v2.6.0-alpha.1 测试版

#### 任务 1.2：GitHub Actions CI/CD（3天）
- [ ] 配置自动化测试工作流
  - Windows Server 2019/2022 矩阵
  - Node.js 16/18/20/22 矩阵
  - 运行所有测试套件
- [ ] 配置预构建二进制工作流
  - 使用 `prebuildify` 或 `node-pre-gyp`
  - 多版本 Node.js 编译
  - 上传到 GitHub Releases
- [ ] 配置发布工作流
  - 自动发布到 npm
  - 创建 GitHub Release
  - 生成 Changelog

**交付物**：
- `.github/workflows/test.yml`
- `.github/workflows/prebuild.yml`
- `.github/workflows/release.yml`
- 可用的 npm 包（alpha 版本）

---

### 第二阶段：内存分析与优化（Week 2）

**目标**：深入理解内存使用，发现优化机会

#### 任务 2.1：V8 GC 行为分析（2天）
- [ ] 编写内存压力测试脚本
  - 长时间运行（1小时）
  - 高频率音频捕获
  - 模拟真实 ASR 使用场景
- [ ] 使用 V8 profiler 收集数据
  - `--expose-gc` 运行测试
  - `v8-profiler-next` 生成堆快照
  - Chrome DevTools 分析
- [ ] 分析关键指标
  - GC 频率和耗时
  - 内存分配速率
  - Buffer 生命周期
- [ ] 编写分析报告

#### 任务 2.2：零拷贝架构探索（3天）
- [ ] 研究 N-API External Buffer
  - 直接暴露 C++ 内存给 JS
  - 避免 memcpy
- [ ] 设计新的 API（兼容性考虑）
  - 保留现有 `data` 事件（向后兼容）
  - 新增 `rawData` 事件（零拷贝）
- [ ] 原型实现
  - C++ 层实现 External Buffer
  - JS 层适配
  - 性能对比测试
- [ ] 决策：是否合并到 v2.6
  - 如果稳定 → 合并
  - 如果需要更多测试 → 延后到 v2.7

**交付物**：
- `docs/V2.6_MEMORY_ANALYSIS.md`
- 零拷贝原型代码（`feature/zero-copy` 分支）
- 性能对比数据

---

### 第三阶段：音频效果处理（Week 2-3）

**目标**：实现基础音频效果，为应用层提供支持

#### 任务 3.1：AGC（自动增益控制）实现（3天）
- [ ] 设计 API
  ```cpp
  class AudioEffects {
  public:
    void setAGC(bool enable, float targetLevel = 0.8f);
    void applyAGC(float* buffer, size_t samples);
  };
  ```
- [ ] C++ 实现
  - RMS 计算
  - 动态增益调整
  - 平滑处理（避免突变）
- [ ] 集成到 AudioProcessingPipeline
  - 新增 `agc` 配置选项
  - 在重采样后应用
- [ ] 测试和文档

#### 任务 3.2：基础降噪（Noise Gate）（2天）
- [ ] 实现门限降噪
  - 计算音频能量
  - 低于阈值 → 静音
  - 高于阈值 → 保持
- [ ] 配置选项
  - `noiseGate: { threshold: -40, attack: 10ms, release: 50ms }`
- [ ] 集成到 Pipeline
- [ ] 测试和文档

#### 任务 3.3：更多采样率支持（1天）
- [ ] 扩展 Resampler 支持
  - 8000 Hz（电话质量）
  - 24000 Hz（中等质量）
  - 32000 Hz（高质量）
- [ ] 添加预设配置
  - `phone-quality` → 8kHz
  - `medium-quality` → 24kHz
- [ ] 测试和文档

**交付物**：
- `src/audio_effects.h/cpp`
- 更新的 `AudioProcessingPipeline`
- `examples/audio-effects-example.js`
- `docs/AUDIO_EFFECTS_GUIDE.md`

---

### 第四阶段：测试、文档、发布（Week 3）

#### 任务 4.1：完整测试（2天）
- [ ] 新功能单元测试
  - AGC 测试
  - Noise Gate 测试
  - 新采样率测试
- [ ] 集成测试
  - 完整 Pipeline 测试
  - 内存泄漏测试
- [ ] 性能基准测试
  - 对比 v2.5.0
  - 确保无性能退化

#### 任务 4.2：文档完善（2天）
- [ ] 更新 README.md
  - v2.6.0 特性介绍
  - 音频效果处理示例
- [ ] 编写发布说明
  - `docs/V2.6_RELEASE_NOTES.md`
  - 列出所有新特性
  - 性能对比数据
  - 迁移指南（如有破坏性变更）
- [ ] 更新 API 文档
  - 新增 API 详细说明
  - TypeScript 类型定义

#### 任务 4.3：发布准备（1天）
- [ ] 版本号更新
  - `package.json` → 2.6.0
  - README 徽章
- [ ] 创建 Git tag
- [ ] 触发 CI/CD 发布流程
- [ ] 验证 npm 包可用
- [ ] 发布 GitHub Release
- [ ] 社区公告

**交付物**：
- 完整的 v2.6.0 发布包
- npm 上可用的稳定版本
- 完整文档

---

## 📦 预期交付成果

### 代码层面
- ✅ npm 可安装的包（`npm install node-windows-audio-capture@2.6.0`）
- ✅ 预构建二进制（Windows x64, Node.js 16/18/20/22）
- ✅ AGC（自动增益控制）功能
- ✅ Noise Gate（门限降噪）功能
- ✅ 扩展采样率支持（8/24/32 kHz）
- ✅ 零拷贝架构原型（可能延后到 v2.7）

### 基础设施
- ✅ GitHub Actions CI/CD
- ✅ 自动化测试（多版本 Node.js）
- ✅ 自动化预构建
- ✅ 自动化发布流程

### 文档
- ✅ V2.6 发布说明
- ✅ 内存分析报告
- ✅ 音频效果处理指南
- ✅ npm 发布指南

---

## 🎯 成功标准

### 功能完整性
- [ ] 所有 P0 任务完成
- [ ] 至少 80% P1 任务完成
- [ ] 测试覆盖率 ≥ 85%

### 性能指标
- [ ] 内存使用相比 v2.5 降低或持平
- [ ] CPU 占用增加 < 5%（AGC/Noise Gate 启用时）
- [ ] 无内存泄漏（1小时运行测试）

### 生态指标
- [ ] npm 包可正常安装
- [ ] 预构建二进制覆盖 90%+ 用户场景
- [ ] CI/CD 工作流稳定运行

---

## ⚠️ 风险与挑战

### 技术风险

1. **零拷贝实现复杂度** 🔴 高风险
   - 问题：N-API External Buffer 生命周期管理复杂
   - 缓解：先做原型，稳定后再合并；可延后到 v2.7
   - 后备方案：保持现有架构，仅优化 Buffer 池

2. **预构建二进制兼容性** 🟡 中等风险
   - 问题：不同 Node.js/Electron 版本 ABI 不兼容
   - 缓解：使用 `prebuildify` 自动处理 ABI 版本
   - 后备方案：提供源码编译文档

3. **AGC 音质影响** 🟡 中等风险
   - 问题：增益控制不当可能导致失真
   - 缓解：充分测试，提供可调参数
   - 后备方案：默认关闭，用户手动启用

### 时间风险

1. **CI/CD 配置复杂** 🟡 中等风险
   - 问题：GitHub Actions Windows 环境配置复杂
   - 缓解：参考成熟项目配置（如 `node-pty`）
   - 后备方案：简化工作流，先实现基础功能

---

## 📈 后续版本预览

### v2.7 - 音质增强版
- 高级降噪（RNNoise 集成）
- 可配置 Kaiser 参数
- 均衡器（3频段/10频段）

### v2.8 - 性能优化版
- SIMD 优化（重采样加速）
- 多线程处理
- 零拷贝架构（如 v2.6 未完成）

### v3.0 - 跨平台版
- macOS 支持（Core Audio）
- Linux 支持（PulseAudio）
- 统一 API

---

## 📚 参考资料

### 类似项目研究
- [node-pty](https://github.com/microsoft/node-pty) - 预构建二进制最佳实践
- [sharp](https://github.com/lovell/sharp) - npm 发布和 CI/CD
- [sqlite3](https://github.com/TryGhost/node-sqlite3) - 多版本 Node.js 支持

### 技术文档
- [N-API External Buffer](https://nodejs.org/api/n-api.html#n_api_napi_create_external_buffer)
- [V8 Heap Profiler](https://v8.dev/docs/profile)
- [AGC 算法](https://en.wikipedia.org/wiki/Automatic_gain_control)
- [Noise Gate 算法](https://en.wikipedia.org/wiki/Noise_gate)

---

## 🚀 开始开发

### 第一步：创建开发分支
```bash
git checkout -b feature/v2.6-development
```

### 第二步：配置开发环境
```bash
# 安装额外依赖
npm install --save-dev prebuildify
npm install --save-dev @mapbox/node-pre-gyp
npm install --save-dev v8-profiler-next

# 安装 CI/CD 工具
npm install --save-dev semantic-release
```

### 第三步：开始第一个任务
```bash
# 创建 npm 发布配置
code .npmignore
code package.json
```

---

**准备好了吗？让我们开始 v2.6 的开发之旅！** 🚀

---

*文档创建时间: 2025-10-15*  
*预计完成时间: 2025-11-05*  
*负责人: @wujelly701*
